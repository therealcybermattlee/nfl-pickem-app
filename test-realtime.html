<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Pick'em Real-Time Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status { 
            padding: 10px; 
            border-radius: 4px; 
            margin-bottom: 10px; 
            font-weight: bold;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .reconnecting { background-color: #fff3cd; color: #856404; }
        .event {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
            font-family: monospace;
            font-size: 14px;
        }
        .event-type-GameLockEvent { border-left-color: #ffc107; }
        .event-type-ScoreUpdateEvent { border-left-color: #28a745; }
        .event-type-PickSubmittedEvent { border-left-color: #17a2b8; }
        .event-type-AutoPickGeneratedEvent { border-left-color: #fd7e14; }
        .event-type-GameCompletedEvent { border-left-color: #6f42c1; }
        .event-type-LeaderboardUpdateEvent { border-left-color: #e83e8c; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <h1>üèà NFL Pick'em Real-Time System Test</h1>
    
    <div class="grid">
        <div class="container">
            <h2>Connection Status</h2>
            <div id="status" class="status disconnected">Disconnected</div>
            <div>
                <button id="connectBtn" onclick="connect()">Connect SSE</button>
                <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
                <button id="pollBtn" onclick="pollEvents()">Poll Events</button>
                <button id="clearBtn" onclick="clearEvents()">Clear Events</button>
            </div>
            <div style="margin-top: 15px;">
                <p><strong>Events Received:</strong> <span id="eventCount">0</span></p>
                <p><strong>Last Event ID:</strong> <span id="lastEventId">0</span></p>
                <p><strong>Connection Type:</strong> <span id="connectionType">None</span></p>
            </div>
        </div>
        
        <div class="container">
            <h2>Test Actions</h2>
            <button onclick="createTestEvent('GameLockEvent')">üîí Create Game Lock Event</button>
            <button onclick="createTestEvent('ScoreUpdateEvent')">‚öΩ Create Score Update</button>
            <button onclick="createTestEvent('PickSubmittedEvent')">‚úÖ Create Pick Submitted</button>
            <button onclick="createTestEvent('AutoPickGeneratedEvent')">ü§ñ Create Auto-Pick</button>
            <button onclick="createTestEvent('LeaderboardUpdateEvent')">üèÜ Create Leaderboard Update</button>
            
            <div style="margin-top: 15px;">
                <h3>Live Data Endpoints</h3>
                <button onclick="fetchLiveScores()">üìä Fetch Live Scores</button>
                <button onclick="fetchLiveLeaderboard()">üéØ Fetch Live Leaderboard</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <h2>Real-Time Events</h2>
        <div id="events"></div>
    </div>
    
    <div class="container">
        <h2>API Response Log</h2>
        <div id="apiLog"></div>
    </div>

    <script>
        const API_BASE = 'https://nfl-pickem-app-production.cybermattlee-llc.workers.dev';
        let eventSource = null;
        let eventCount = 0;
        let lastEventId = 0;

        function updateStatus(message, type = 'disconnected') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            
            document.getElementById('connectBtn').disabled = (type === 'connected' || type === 'reconnecting');
            document.getElementById('disconnectBtn').disabled = (type === 'disconnected');
        }

        function logEvent(event) {
            eventCount++;
            lastEventId = Math.max(lastEventId, event.id || 0);
            
            document.getElementById('eventCount').textContent = eventCount;
            document.getElementById('lastEventId').textContent = lastEventId;
            
            const eventsDiv = document.getElementById('events');
            const eventDiv = document.createElement('div');
            eventDiv.className = `event event-type-${event.type}`;
            eventDiv.innerHTML = `
                <strong>${event.type}</strong> - ${new Date(event.created_at || Date.now()).toLocaleTimeString()}<br>
                <pre>${JSON.stringify(event.payload, null, 2)}</pre>
            `;
            eventsDiv.insertBefore(eventDiv, eventsDiv.firstChild);
            
            // Keep only last 10 events
            while (eventsDiv.children.length > 10) {
                eventsDiv.removeChild(eventsDiv.lastChild);
            }
        }

        function logApiResponse(endpoint, data, error = null) {
            const logDiv = document.getElementById('apiLog');
            const responseDiv = document.createElement('div');
            responseDiv.className = 'event';
            responseDiv.innerHTML = `
                <strong>${endpoint}</strong> - ${new Date().toLocaleTimeString()}<br>
                ${error ? 
                    `<span style="color: red;">ERROR: ${error}</span>` : 
                    `<pre>${JSON.stringify(data, null, 2)}</pre>`
                }
            `;
            logDiv.insertBefore(responseDiv, logDiv.firstChild);
            
            // Keep only last 5 responses
            while (logDiv.children.length > 5) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        function connect() {
            if (eventSource) {
                eventSource.close();
            }
            
            updateStatus('Connecting...', 'reconnecting');
            document.getElementById('connectionType').textContent = 'Server-Sent Events';
            
            const url = `${API_BASE}/api/events/stream?lastEventId=${lastEventId}`;
            eventSource = new EventSource(url);
            
            eventSource.onopen = function() {
                updateStatus('Connected via SSE', 'connected');
            };
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    logEvent(data);
                } catch (e) {
                    console.error('Failed to parse event:', e);
                }
            };
            
            eventSource.onerror = function() {
                updateStatus('Connection Error', 'disconnected');
                document.getElementById('connectionType').textContent = 'None';
                eventSource = null;
            };
            
            // Listen for specific event types
            const eventTypes = ['GameLockEvent', 'ScoreUpdateEvent', 'PickSubmittedEvent', 
                              'AutoPickGeneratedEvent', 'GameCompletedEvent', 'LeaderboardUpdateEvent'];
            
            eventTypes.forEach(eventType => {
                eventSource.addEventListener(eventType, function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        logEvent(data);
                    } catch (e) {
                        console.error(`Failed to parse ${eventType}:`, e);
                    }
                });
            });
        }

        function disconnect() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            updateStatus('Disconnected', 'disconnected');
            document.getElementById('connectionType').textContent = 'None';
        }

        async function pollEvents() {
            try {
                document.getElementById('connectionType').textContent = 'Polling';
                const response = await fetch(`${API_BASE}/api/events/poll?lastEventId=${lastEventId}`);
                const data = await response.json();
                
                logApiResponse('Poll Events', data);
                
                data.events?.forEach(event => {
                    logEvent(event);
                });
                
                updateStatus(`Polled - ${data.events?.length || 0} new events`, 'connected');
                setTimeout(() => {
                    if (document.getElementById('status').textContent.startsWith('Polled')) {
                        updateStatus('Disconnected', 'disconnected');
                        document.getElementById('connectionType').textContent = 'None';
                    }
                }, 3000);
                
            } catch (error) {
                logApiResponse('Poll Events', null, error.message);
                updateStatus('Poll Error', 'disconnected');
            }
        }

        function clearEvents() {
            document.getElementById('events').innerHTML = '';
            document.getElementById('apiLog').innerHTML = '';
            eventCount = 0;
            document.getElementById('eventCount').textContent = '0';
        }

        async function createTestEvent(eventType) {
            try {
                const payloads = {
                    'GameLockEvent': {
                        gameId: 'test-game-001',
                        lockTime: new Date().toISOString(),
                        teamsAffected: {
                            homeTeam: { id: 'KC', name: 'Kansas City Chiefs', abbreviation: 'KC' },
                            awayTeam: { id: 'BUF', name: 'Buffalo Bills', abbreviation: 'BUF' }
                        }
                    },
                    'ScoreUpdateEvent': {
                        gameId: 'test-game-001',
                        homeScore: Math.floor(Math.random() * 35),
                        awayScore: Math.floor(Math.random() * 35),
                        quarter: Math.floor(Math.random() * 4) + 1,
                        status: 'in_progress'
                    },
                    'PickSubmittedEvent': {
                        userId: 1,
                        gameId: 'test-game-001',
                        teamPicked: { id: 'KC', name: 'Kansas City Chiefs', abbreviation: 'KC' },
                        submittedAt: new Date().toISOString()
                    },
                    'AutoPickGeneratedEvent': {
                        userId: 2,
                        gameId: 'test-game-001',
                        teamPicked: { id: 'BUF', name: 'Buffalo Bills', abbreviation: 'BUF' },
                        reason: 'game_locked',
                        generatedAt: new Date().toISOString()
                    },
                    'LeaderboardUpdateEvent': {
                        week: 1,
                        season: 2025,
                        rankings: [
                            { userId: 1, position: 1, points: 5, change: 0 },
                            { userId: 2, position: 2, points: 3, change: 1 }
                        ],
                        triggeredBy: 'game_completed',
                        updatedAt: new Date().toISOString()
                    }
                };

                const response = await fetch(`${API_BASE}/api/events`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: eventType,
                        payload: payloads[eventType],
                        scope: 'global'
                    })
                });

                const data = await response.json();
                logApiResponse(`Create ${eventType}`, data);

            } catch (error) {
                logApiResponse(`Create ${eventType}`, null, error.message);
            }
        }

        async function fetchLiveScores() {
            try {
                const response = await fetch(`${API_BASE}/api/games/live-scores`);
                const data = await response.json();
                logApiResponse('Live Scores', data);
            } catch (error) {
                logApiResponse('Live Scores', null, error.message);
            }
        }

        async function fetchLiveLeaderboard() {
            try {
                const response = await fetch(`${API_BASE}/api/leaderboard/live`);
                const data = await response.json();
                logApiResponse('Live Leaderboard', data);
            } catch (error) {
                logApiResponse('Live Leaderboard', null, error.message);
            }
        }

        // Initialize
        updateStatus('Ready to connect', 'disconnected');
    </script>
</body>
</html>