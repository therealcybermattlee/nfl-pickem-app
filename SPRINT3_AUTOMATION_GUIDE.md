# Sprint 3: Game State Automation - Implementation Guide

## üöÄ Overview

Sprint 3 implements comprehensive game state automation using Cloudflare Cron Triggers. The system automatically:

1. **Locks games** when their lock time is reached
2. **Auto-generates picks** for users who forgot to pick
3. **Updates scores** from ESPN API during games
4. **Awards points** when games are completed
5. **Monitors and logs** all automation activities
6. **Handles failures** gracefully with circuit breaker patterns

## ‚öôÔ∏è Cron Schedule Configuration

### Smart Scheduling by Game Day

The system uses intelligent scheduling based on NFL game patterns:

```toml
# wrangler.toml cron configuration
[triggers]
crons = [
  # High-frequency during game days (Thu-Mon): Every 15 minutes
  "*/15 * * * 4",    # Thursday: TNF games
  "*/15 * * * 5",    # Friday: Rare games  
  "*/15 * * * 6",    # Saturday: Late season
  "*/15 * * * 0",    # Sunday: Main game day
  "*/15 * * * 1",    # Monday: MNF games
  
  # Lower frequency during off-game days (Tue-Wed): Every 2 hours
  "0 */2 * * 2",     # Tuesday: Maintenance
  "0 */2 * * 3",     # Wednesday: Preparation
  
  # Special schedules for critical times
  "0 9,12,15,18,21 * 9-12,1-2 *",  # NFL season: 4 times daily
  "0 */6 * 3-8 *"    # Off-season: Every 6 hours
]
```

### Scheduling Logic

The automation intelligently determines when to run:

- **Game Days (Thu-Mon)**: Every 15 minutes during NFL season
- **Off-Game Days (Tue-Wed)**: Every 2 hours during NFL season  
- **Off-Season (Mar-Aug)**: Every 6 hours for maintenance
- **Season Detection**: Automatic based on current month

## üîß Core Automation Workflow

### Step-by-Step Process

```typescript
async function gameStateAutomation(db, env, ctx, executionId, startTime, dryRun = false)
```

**Step 1: Update Game Lock Statuses**
- Query games where `datetime(lockTime) <= datetime('now')`
- Update game status from `'upcoming'` to `'locked'`
- Insert records into `game_locks` table
- Log results to system_logs

**Step 2: Auto-Generate Picks**
- Find locked games with missing user picks
- Randomly select home or away team for each missing pick
- Insert auto-generated picks with `autoGenerated = true`
- Update `game_locks` with `autoPicksGenerated = 1`

**Step 3: Update Game Scores**
- Get games that are in-progress or recently completed
- Fetch latest scores from ESPN API (with circuit breaker protection)
- Update game scores and completion status
- Award points to correct picks when games complete

**Step 4: Log Results**
- Comprehensive metrics logging
- System event tracking
- Performance monitoring
- Error collection and reporting

## üìä Monitoring & Observability

### System Logs Table

```sql
CREATE TABLE system_logs (
  id TEXT PRIMARY KEY,
  executionId TEXT NOT NULL,
  eventType TEXT NOT NULL,      -- 'cron_success', 'game_lock_update', etc.
  status TEXT NOT NULL,         -- 'success', 'error', 'warning', 'info'
  message TEXT NOT NULL,
  duration INTEGER,
  details TEXT,                 -- JSON with detailed metrics
  gamesAffected INTEGER DEFAULT 0,
  picksGenerated INTEGER DEFAULT 0,
  pointsAwarded INTEGER DEFAULT 0,
  createdAt TEXT DEFAULT (datetime('now'))
)
```

### API Endpoints for Monitoring

**System Logs**: `GET /api/system/logs`
- Query parameters: `limit`, `type`, `status`
- Returns filtered system events

**System Metrics**: `GET /api/system/metrics`
- Query parameters: `hours` (default 24)
- Aggregated statistics by event type and status

**Manual Trigger**: `POST /api/automation/trigger`
- Body: `{ "dryRun": true/false }`
- For testing automation without waiting for cron

## ‚ö° Circuit Breaker Pattern

### ESPN API Protection

```sql
CREATE TABLE circuit_breaker_state (
  id TEXT PRIMARY KEY DEFAULT 'espn_api',
  isOpen INTEGER DEFAULT 0,
  failureCount INTEGER DEFAULT 0,
  lastFailure TEXT,
  nextAttempt TEXT,
  updatedAt TEXT DEFAULT (datetime('now'))
)
```

**Circuit Breaker Logic:**
- **Closed**: Normal operation, all API calls allowed
- **Open**: After 3 consecutive failures, block API calls for 5 minutes
- **Half-Open**: After timeout, allow one test call

**Benefits:**
- Prevents API rate limiting
- Graceful degradation during ESPN outages
- Automatic recovery when service returns

## üîÑ Retry Logic & Error Handling

### Exponential Backoff

```typescript
// Retry attempts: 1s, 2s, 4s (max 10s)
const waitTime = Math.min(1000 * Math.pow(2, attempt - 1), 10000)
```

**Retry Strategy:**
- Maximum 3 attempts for ESPN API calls
- Exponential backoff between attempts
- Continue automation even if ESPN fails
- Log all attempts and failures

### Error Recovery

**Database Errors**: Continue with remaining operations
**API Failures**: Use circuit breaker, skip non-critical updates
**Timeout Issues**: Log error, ensure next cron run can recover
**Memory Limits**: Batch operations, process in chunks

## üß™ Testing & Validation

### Manual Testing Endpoints

**Trigger Automation**: `POST /api/automation/trigger`
```json
{
  "dryRun": true  // Test without making changes
}
```

**Dry-Run Mode Features:**
- Simulates all operations without database changes
- Generates fake ESPN API responses
- Logs what would happen in production
- Safe for testing during live games

### Monitoring Queries

```sql
-- Recent automation executions
SELECT * FROM system_logs 
WHERE eventType = 'cron_success' 
ORDER BY createdAt DESC LIMIT 10;

-- Error analysis
SELECT eventType, COUNT(*) as errors
FROM system_logs 
WHERE status = 'error' 
AND createdAt > datetime('now', '-24 hours')
GROUP BY eventType;

-- Performance metrics
SELECT 
  AVG(duration) as avg_duration_ms,
  MAX(duration) as max_duration_ms,
  COUNT(*) as executions
FROM system_logs 
WHERE eventType = 'cron_success' 
AND createdAt > datetime('now', '-7 days');
```

## üöÄ Deployment Process

### Prerequisites

1. **Wrangler CLI**: `npm install -g wrangler`
2. **D1 Database**: Already configured
3. **Environment Secrets**: Set via `wrangler secret put`

### Deploy Commands

```bash
# Deploy to production with cron triggers
wrangler deploy --env production

# Check deployment status
wrangler tail --env production

# Monitor cron executions
wrangler tail --env production --format pretty
```

### Environment Variables

```bash
# Required secrets
wrangler secret put THE_ODDS_API_KEY --env production
wrangler secret put NEXTAUTH_SECRET --env production

# Already configured in wrangler.toml
CURRENT_NFL_SEASON=2025
CURRENT_NFL_WEEK=1
NEXTAUTH_URL=https://nfl-pickem-app-production.cybermattlee-llc.workers.dev
```

## üìà Performance Metrics

### Expected Performance

**Execution Time**: 5-30 seconds per cron run
**Database Operations**: 10-50 queries per execution
**ESPN API Calls**: 1-3 requests per execution
**Memory Usage**: <50MB peak
**Error Rate**: <1% under normal conditions

### Scalability Limits

**Cron Frequency**: 15 minutes minimum (Cloudflare limit)
**Execution Timeout**: 10 minutes (Workers limit)
**Database Concurrent**: 1000 operations per burst
**API Rate Limits**: ESPN has soft limits, circuit breaker protects

## üõ†Ô∏è Troubleshooting Guide

### Common Issues

**"Circuit breaker is open"**
- ESPN API is failing consistently
- Wait 5 minutes for automatic reset
- Check ESPN service status

**"Games not locking"**
- Verify `lockTime` is set correctly on games
- Check timezone handling in lock time calculation
- Manual trigger: `POST /api/automation/trigger`

**"Picks not generating"**
- Ensure users exist in database
- Check game status is 'locked' or 'in_progress'
- Verify `autoPicksGenerated` flag not already set

**"Scores not updating"**
- ESPN API may be down (check circuit breaker)
- Game IDs may not match between systems
- Check game status and isCompleted flags

### Debug Commands

```bash
# View recent logs
curl "https://your-worker.workers.dev/api/system/logs?limit=20"

# Check metrics  
curl "https://your-worker.workers.dev/api/system/metrics?hours=24"

# Manual dry-run test
curl -X POST "https://your-worker.workers.dev/api/automation/trigger" \
  -H "Content-Type: application/json" \
  -d '{"dryRun": true}'
```

## üéØ Success Criteria

### Automation Goals Achieved

‚úÖ **Fully Automated Game Locking**: Games lock at correct times without manual intervention
‚úÖ **Auto-Pick Generation**: Users get random picks for forgotten games
‚úÖ **Real-Time Score Updates**: Scores update during games every 15 minutes
‚úÖ **Automatic Point Awards**: Points awarded immediately when games complete
‚úÖ **Comprehensive Monitoring**: Full visibility into system operations
‚úÖ **Graceful Error Handling**: System continues operating during failures
‚úÖ **Easy Testing**: Dry-run mode for safe validation
‚úÖ **Production Ready**: Circuit breakers, retries, and performance monitoring

### Key Benefits

- **Zero Manual Intervention**: System runs completely automatically
- **Reliable Operations**: Handles ESPN API outages gracefully
- **User Experience**: No missed picks, immediate score updates
- **Operational Visibility**: Complete logs and metrics
- **Scalable Architecture**: Handles increased load and users
- **Maintainable Code**: Clear separation of concerns and comprehensive logging

## üìù Next Steps (Sprint 4+)

**Real-Time UI Updates**: WebSocket integration for live updates
**Advanced Analytics**: Game prediction accuracy, user engagement metrics
**Mobile Notifications**: Push notifications for game results
**Administrative Dashboard**: Web UI for system monitoring and control
**Multi-Season Support**: Playoff scheduling and season transitions

---

**Implementation Complete**: Sprint 3 delivers a production-ready automation system that handles all game state management automatically with comprehensive monitoring and error handling.