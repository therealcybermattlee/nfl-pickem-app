# NFL Pick'em Real-Time API Documentation

## Sprint 4: Real-Time Integration - API Reference

This document describes the real-time event system implemented for the NFL Pick'em application using Cloudflare Workers and D1 database.

## Overview

The real-time system provides live updates for:
- Game locks (when picks are no longer allowed)
- Score updates during games
- Pick submissions by users
- Auto-generated picks for missed deadlines
- Game completions and final scores
- Leaderboard changes

## Architecture

### Technology Stack
- **Backend**: Cloudflare Workers with D1 SQLite database
- **Real-time**: Server-Sent Events (SSE) with polling fallback
- **Event Storage**: Temporary events table with automatic cleanup
- **Authentication**: JWT tokens for user-specific events

### Event Flow
1. Events are created and stored in `events` table
2. SSE clients receive real-time updates via streaming
3. Polling clients can fetch events since last known event ID
4. Events automatically expire after 1 hour and are cleaned up

## API Endpoints

### Real-Time Event Streaming

#### GET `/api/events/stream`
Server-Sent Events endpoint for real-time updates.

**Headers:**
- `Authorization: Bearer <jwt_token>` (optional - for user-specific events)

**Query Parameters:**
- `lastEventId` (optional): Resume from specific event ID

**Response:**
Continuous SSE stream with events in this format:
```
id: 123
event: GameLockEvent
data: {"id":123,"type":"GameLockEvent","payload":{...},"created_at":"2025-09-07T10:00:00Z","scope":"global"}

```

**Connection Management:**
- Heartbeat every 30 seconds
- Automatic reconnection on client disconnect
- Maximum connection lifetime managed by Workers

---

#### GET `/api/events/poll`
Polling fallback for SSE when connection is unstable.

**Headers:**
- `Authorization: Bearer <jwt_token>` (optional)

**Query Parameters:**
- `lastEventId` (required): Get events after this ID
- `timestamp` (alternative to lastEventId): Get events after timestamp

**Response:**
```json
{
  "events": [
    {
      "id": 123,
      "type": "GameLockEvent",
      "payload": { ... },
      "created_at": "2025-09-07T10:00:00Z",
      "scope": "global"
    }
  ],
  "lastEventId": 123,
  "hasMore": false
}
```

---

#### POST `/api/events`
Create events (for testing and internal use).

**Request Body:**
```json
{
  "type": "GameLockEvent",
  "payload": { ... },
  "scope": "global",
  "expiresInMinutes": 60
}
```

**Response:**
```json
{
  "success": true,
  "event": {
    "id": 123,
    "type": "GameLockEvent",
    "payload": { ... },
    "created_at": "2025-09-07T10:00:00Z",
    "expires_at": "2025-09-07T11:00:00Z",
    "scope": "global"
  }
}
```

## Real-Time Data Endpoints

### Live Game Scores

#### GET `/api/games/live-scores`
Get current scores for in-progress games.

**Query Parameters:**
- `week` (optional): NFL week number (default: current week)
- `season` (optional): NFL season year (default: current season)

**Response:**
```json
{
  "liveGames": [
    {
      "gameId": "game-123",
      "homeTeam": {
        "id": "KC",
        "name": "Kansas City Chiefs",
        "abbreviation": "KC",
        "score": 14
      },
      "awayTeam": {
        "id": "BUF",
        "name": "Buffalo Bills", 
        "abbreviation": "BUF",
        "score": 7
      },
      "status": "in_progress",
      "gameTime": "2025-09-07T18:00:00Z",
      "isCompleted": false
    }
  ],
  "week": 1,
  "season": 2025,
  "lastUpdated": "2025-09-07T10:00:00Z"
}
```

### Live Pick Status

#### GET `/api/picks/live-status`
Get real-time pick status for authenticated user.

**Headers:**
- `Authorization: Bearer <jwt_token>` (required)

**Query Parameters:**
- `week` (optional): NFL week number
- `season` (optional): NFL season year

**Response:**
```json
{
  "userPicks": [
    {
      "gameId": "game-123",
      "teamPicked": {
        "id": "KC",
        "name": "Kansas City Chiefs",
        "abbreviation": "KC"
      },
      "isLocked": true,
      "lockedAt": "2025-09-07T17:45:00Z",
      "autoGenerated": false,
      "lockTime": "2025-09-07T18:00:00Z",
      "gameStatus": "in_progress"
    }
  ],
  "userId": 123,
  "week": 1,
  "season": 2025,
  "lastUpdated": "2025-09-07T10:00:00Z"
}
```

### Live Leaderboard

#### GET `/api/leaderboard/live`
Get real-time leaderboard with current standings.

**Query Parameters:**
- `week` (optional): NFL week number
- `season` (optional): NFL season year

**Response:**
```json
{
  "leaderboard": [
    {
      "position": 1,
      "user": {
        "id": 123,
        "name": "John Doe",
        "email": "john@example.com"
      },
      "points": 5,
      "totalPicks": 8,
      "totalGames": 6,
      "winPercentage": 83.3
    }
  ],
  "week": 1,
  "season": 2025,
  "lastUpdated": "2025-09-07T10:00:00Z",
  "isLive": true
}
```

## Event Types

### GameLockEvent
Triggered when a game becomes locked for picks.

```json
{
  "type": "GameLockEvent",
  "payload": {
    "gameId": "game-123",
    "lockTime": "2025-09-07T18:00:00Z",
    "teamsAffected": {
      "homeTeam": {
        "id": "KC",
        "name": "Kansas City Chiefs",
        "abbreviation": "KC"
      },
      "awayTeam": {
        "id": "BUF", 
        "name": "Buffalo Bills",
        "abbreviation": "BUF"
      }
    }
  }
}
```

### ScoreUpdateEvent
Triggered when game scores change.

```json
{
  "type": "ScoreUpdateEvent",
  "payload": {
    "gameId": "game-123",
    "homeScore": 14,
    "awayScore": 7,
    "quarter": 2,
    "timeRemaining": "5:23",
    "status": "in_progress"
  }
}
```

### PickSubmittedEvent
Triggered when a user submits a pick.

```json
{
  "type": "PickSubmittedEvent",
  "payload": {
    "userId": 123,
    "gameId": "game-123",
    "teamPicked": {
      "id": "KC",
      "name": "Kansas City Chiefs",
      "abbreviation": "KC"
    },
    "confidence": 5,
    "submittedAt": "2025-09-07T17:45:00Z"
  }
}
```

### AutoPickGeneratedEvent
Triggered when system generates pick for user who missed deadline.

```json
{
  "type": "AutoPickGeneratedEvent", 
  "payload": {
    "userId": 123,
    "gameId": "game-123",
    "teamPicked": {
      "id": "BUF",
      "name": "Buffalo Bills",
      "abbreviation": "BUF"
    },
    "reason": "game_locked",
    "generatedAt": "2025-09-07T18:00:00Z"
  }
}
```

### GameCompletedEvent
Triggered when a game finishes.

```json
{
  "type": "GameCompletedEvent",
  "payload": {
    "gameId": "game-123", 
    "winnerId": "KC",
    "finalScore": {
      "home": 28,
      "away": 21
    },
    "completedAt": "2025-09-07T21:30:00Z",
    "gameDetails": {
      "homeTeam": {"id": "KC", "name": "Kansas City Chiefs", "abbreviation": "KC"},
      "awayTeam": {"id": "BUF", "name": "Buffalo Bills", "abbreviation": "BUF"},
      "week": 1,
      "season": 2025
    }
  }
}
```

### LeaderboardUpdateEvent
Triggered when leaderboard positions change.

```json
{
  "type": "LeaderboardUpdateEvent",
  "payload": {
    "week": 1,
    "season": 2025,
    "rankings": [
      {
        "userId": 123,
        "position": 1, 
        "points": 6,
        "change": 0
      },
      {
        "userId": 456,
        "position": 2,
        "points": 5,
        "change": 1
      }
    ],
    "triggeredBy": "game_completed",
    "updatedAt": "2025-09-07T21:30:00Z"
  }
}
```

## Event Scopes

Events can have different scopes:
- `global`: Visible to all users
- `user:123`: Visible only to user with ID 123

User-specific events are only sent to authenticated connections with matching user ID.

## Client Implementation

### JavaScript SSE Client

```javascript
const eventSource = new EventSource('/api/events/stream');

eventSource.onmessage = function(event) {
    const data = JSON.parse(event.data);
    handleRealTimeEvent(data);
};

eventSource.addEventListener('GameLockEvent', function(event) {
    const data = JSON.parse(event.data);
    showGameLockNotification(data);
});
```

### Polling Fallback

```javascript
async function pollForEvents(lastEventId) {
    const response = await fetch(`/api/events/poll?lastEventId=${lastEventId}`);
    const data = await response.json();
    
    data.events.forEach(event => {
        handleRealTimeEvent(event);
    });
    
    return data.lastEventId;
}
```

### React Hook

```javascript
import { useRealTimeUpdates } from './hooks/useRealTimeUpdates';

function MyComponent() {
    const {
        events,
        isConnected,
        getEventsByType
    } = useRealTimeUpdates({
        userId: currentUser.id,
        authToken: userToken
    });
    
    const gameLockEvents = getEventsByType('GameLockEvent');
    
    return (
        <div>
            <ConnectionStatus isConnected={isConnected} />
            <GameLockNotifications events={gameLockEvents} />
        </div>
    );
}
```

## Testing

### Manual Testing

1. Open `test-realtime.html` in browser
2. Click "Connect SSE" to establish real-time connection
3. Use test buttons to create events
4. Observe real-time updates in the events panel

### Production Testing

```bash
# Test SSE endpoint
curl -N -H "Accept: text/event-stream" \
  "https://nfl-pickem-app-production.cybermattlee-llc.workers.dev/api/events/stream"

# Test polling endpoint
curl "https://nfl-pickem-app-production.cybermattlee-llc.workers.dev/api/events/poll?lastEventId=0"

# Create test event
curl -X POST "https://nfl-pickem-app-production.cybermattlee-llc.workers.dev/api/events" \
  -H "Content-Type: application/json" \
  -d '{"type":"GameLockEvent","payload":{"gameId":"test","lockTime":"2025-09-07T18:00:00Z","teamsAffected":{"homeTeam":{"id":"KC","name":"Kansas City Chiefs","abbreviation":"KC"},"awayTeam":{"id":"BUF","name":"Buffalo Bills","abbreviation":"BUF"}}}}'
```

## Performance Considerations

- Events auto-expire after 1 hour to prevent database bloat
- Cleanup runs automatically during event creation (10% probability)
- SSE connections have heartbeat to detect disconnections
- Polling clients should use appropriate intervals (5-30 seconds)
- Maximum 50 events per request to avoid large responses

## Error Handling

- SSE connections automatically retry with exponential backoff
- Polling includes fallback for network errors
- Invalid JWT tokens result in anonymous (global events only) access
- Database errors return empty event arrays with error logging

## Security

- JWT authentication for user-specific events
- Event scopes prevent unauthorized access to user data
- Rate limiting should be implemented for event creation endpoint
- Events contain no sensitive information beyond user IDs

## Production Deployment

The real-time system is deployed as part of the main Cloudflare Workers application:

```bash
npx wrangler deploy --config wrangler-workers.toml --env production
```

Events table and indexes are automatically created in the D1 database.

## Status

âœ… **Sprint 4 Complete** - Real-time integration implemented with:
- Server-Sent Events streaming endpoint
- Polling fallback mechanism  
- Event broadcasting system
- Live data endpoints for scores, picks, and leaderboard
- React client components and hooks
- Comprehensive testing tools
- Full documentation

**Next Steps**: Integration testing with frontend components and optimization for high-traffic scenarios.