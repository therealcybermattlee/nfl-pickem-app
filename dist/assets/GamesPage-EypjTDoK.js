import{j as e}from"./index-C9195Kw7.js";import{r as n}from"./vendor-DLdglawL.js";import{A as T}from"./api-9Tv9JkjW.js";import{B as D,G as F,a as z}from"./GameCard-C9sDE2BN.js";function G(i={}){const{userId:w,authToken:j,fallbackToPolling:v=!0,pollingInterval:L=5e3,reconnectInterval:p=3e3,maxReconnectAttempts:b=5}=i,[l,u]=n.useState({events:[],isConnected:!1,isReconnecting:!1,lastEventId:0}),d=n.useRef(null),y=n.useRef(null),k=n.useRef(null),E=n.useRef(0),x=n.useRef(!0),S="https://nfl-pickem-app-production.cybermattlee-llc.workers.dev",h=n.useCallback(()=>{d.current&&(d.current.close(),d.current=null),y.current&&(clearTimeout(y.current),y.current=null),k.current&&(clearTimeout(k.current),k.current=null)},[]),N=n.useCallback(t=>{x.current&&u(a=>({...a,events:[...a.events,t],lastEventId:Math.max(a.lastEventId,t.id)}))},[]),P=n.useCallback(t=>{x.current&&(u(a=>({...a,isConnected:!1,connectionError:t})),E.current<b?(u(a=>({...a,isReconnecting:!0})),k.current=setTimeout(()=>{x.current&&(E.current++,m())},p)):v&&(console.log("Max SSE reconnect attempts reached, falling back to polling"),f()))},[v,b,p]),m=n.useCallback(()=>{if(x.current){h();try{const t={};j&&(t.Authorization=`Bearer ${j}`);const a=new URL(`${S}/api/events/stream`);l.lastEventId>0&&a.searchParams.set("lastEventId",l.lastEventId.toString()),d.current=new EventSource(a.toString()),d.current.onopen=()=>{x.current&&(u(r=>({...r,isConnected:!0,isReconnecting:!1,connectionError:void 0})),E.current=0)},d.current.onmessage=r=>{try{const o=JSON.parse(r.data);N(o)}catch(o){console.error("Failed to parse SSE event:",o)}},d.current.onerror=()=>{P("SSE connection error")},["GameLockEvent","ScoreUpdateEvent","PickSubmittedEvent","AutoPickGeneratedEvent","GameCompletedEvent","LeaderboardUpdateEvent"].forEach(r=>{var o;(o=d.current)==null||o.addEventListener(r,U=>{try{const $=JSON.parse(U.data);N($)}catch(A){console.error(`Failed to parse ${r} event:`,A)}})})}catch(t){console.error("Failed to create SSE connection:",t),v&&f()}}},[S,j,l.lastEventId,N,P,v,h]),g=n.useCallback(async()=>{if(x.current)try{const t={"Content-Type":"application/json"};j&&(t.Authorization=`Bearer ${j}`);const a=new URL(`${S}/api/events/poll`);a.searchParams.set("lastEventId",l.lastEventId.toString());const c=await fetch(a.toString(),{headers:t});if(!c.ok)throw new Error(`Polling failed: ${c.status}`);const r=await c.json();u(o=>({...o,isConnected:!0,connectionError:void 0})),r.events.forEach(N)}catch(t){console.error("Polling error:",t),u(a=>({...a,isConnected:!1,connectionError:t instanceof Error?t.message:"Unknown polling error"}))}},[S,j,l.lastEventId,N]),f=n.useCallback(()=>{h(),g(),y.current=setInterval(()=>{x.current&&g()},L),u(t=>({...t,isReconnecting:!1}))},[g,L,h]),C=n.useCallback(()=>{"EventSource"in window&&!v?m():f()},[m,f,v]),M=n.useCallback(()=>{h(),u(t=>({...t,isConnected:!1,isReconnecting:!1}))},[h]),R=n.useCallback(()=>{u(t=>({...t,events:[]}))},[]);n.useEffect(()=>(x.current=!0,C(),()=>{x.current=!1,h()}),[C,h]);const I=n.useCallback(t=>l.events.filter(a=>a.type===t),[l.events]),s=n.useCallback(t=>l.events.filter(a=>a.scope===`user:${t}`||a.payload&&"userId"in a.payload&&a.payload.userId===t),[l.events]);return{events:l.events,isConnected:l.isConnected,isReconnecting:l.isReconnecting,lastEventId:l.lastEventId,connectionError:l.connectionError,connect:C,disconnect:M,clearEvents:R,getEventsByType:I,getUserEvents:s}}const B=[{id:"dad-user-id",name:"Dad"},{id:"mom-user-id",name:"Mom"},{id:"twobow-user-id",name:"TwoBow"},{id:"rocky-user-id",name:"RockyDaRock"}];function _(){const[i,w]=n.useState([]),[j,v]=n.useState(!0),[L,p]=n.useState(null),[b,l]=n.useState(1),[u]=n.useState(2025),[d,y]=n.useState(new Map),[k,E]=n.useState("list"),[x]=n.useState(0),[S]=n.useState(!0),[h,N]=n.useState(""),P=void 0,m=h||void 0,g=G({userId:m,authToken:P,fallbackToPolling:!0,pollingInterval:1e4}),f=n.useCallback(async()=>{v(!0);try{const s=await T.getGames(b,u);if(s.success&&s.data)try{const t=await T.getGameStatus(b,u);if(t.success&&t.data){const a=s.data.map(c=>{var o;const r=(o=t.data)==null?void 0:o.find(U=>U.id===c.id);return{...c,isLocked:(r==null?void 0:r.isLocked)||!1,lockTime:(r==null?void 0:r.lockTime)||c.gameDate,timeToLock:(r==null?void 0:r.timeUntilLock)||0,isLockingSoon:((r==null?void 0:r.timeUntilLock)||0)<=36e5&&!(r!=null&&r.isLocked)}});w(a)}else w(s.data)}catch{w(s.data)}else p(s.error||"Failed to load games")}catch{p("Failed to load games")}finally{v(!1)}},[b,u]),C=n.useCallback(async()=>{if(m)try{const s=await T.get("/api/picks");if(s.success&&s.data){const t=s.data.picks||[],a=i.map(o=>o.id),c=t.filter(o=>o.userId===m&&a.includes(o.gameId)),r=new Map(c.map(o=>[o.gameId,o.teamId]));y(r)}}catch(s){console.error("Failed to fetch user picks:",s)}},[m,i]),M=n.useCallback(async(s,t)=>{if(!m){p("Please select a user to submit picks");return}try{const a=await T.submitPick({gameId:s,teamId:t,userId:m},"");a.success?(y(c=>new Map(c).set(s,t)),p(null)):p(a.error||"Failed to submit pick")}catch{p("Failed to submit pick")}},[m]);if(n.useEffect(()=>{const s=t=>{switch(t.type){case"GameLockEvent":f();break;case"ScoreUpdateEvent":w(a=>a.map(c=>c.id===t.payload.gameId?{...c,homeScore:t.payload.homeScore,awayScore:t.payload.awayScore}:c));break;case"GameCompletedEvent":w(a=>a.map(c=>c.id===t.payload.gameId?{...c,isCompleted:!0,winnerTeamId:t.payload.winnerId}:c));break;case"AutoPickGeneratedEvent":t.payload.userId===m&&y(a=>new Map(a).set(t.payload.gameId,t.payload.teamPicked.id));break}};g.events.forEach(s)},[g.events,f,m]),n.useEffect(()=>{f()},[f]),n.useEffect(()=>{C()},[C,h]),j)return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("div",{className:"h-8 w-32 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-24 bg-gray-200 rounded animate-pulse"})]}),[...Array(3)].map((s,t)=>e.jsxs("div",{className:"bg-white rounded-lg border p-6 animate-pulse",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsx("div",{className:"h-4 w-24 bg-gray-200 rounded"}),e.jsx("div",{className:"h-6 w-16 bg-gray-200 rounded-full"})]}),e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center space-x-6",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-200 rounded-full"}),e.jsx("div",{className:"h-8 w-8 bg-gray-200 rounded"}),e.jsx("div",{className:"w-16 h-16 bg-gray-200 rounded-full"})]})})]},t))]});if(L)return e.jsxs("div",{className:"text-center py-8",children:[e.jsx("h2",{className:"text-2xl font-semibold text-red-600 mb-4",children:"Error Loading Games"}),e.jsx("p",{className:"text-gray-600 mb-4",children:L}),e.jsx("button",{onClick:()=>{p(null),f()},className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors",children:"Retry"})]});const R=i.map(s=>({id:s.id,deadline:new Date(new Date(s.gameDate).getTime()-x*60*1e3),userHasPick:d.has(s.id)})),I={upcoming:i.filter(s=>!s.isCompleted&&!s.isLocked).length,locked:i.filter(s=>!s.isCompleted&&s.isLocked).length,inProgress:i.filter(s=>!s.isCompleted&&s.isLocked&&new Date(s.gameDate)<=new Date).length,final:i.filter(s=>s.isCompleted).length};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"sticky top-0 z-10 bg-white/95 backdrop-blur-sm border-b p-4 -m-4 mb-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl sm:text-4xl font-bold",children:"NFL Games"}),e.jsxs("div",{className:"flex items-center space-x-2 sm:hidden",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${g.isConnected?"bg-green-500":"bg-red-500"}`}),e.jsx("span",{className:"text-xs text-gray-500",children:g.isConnected?"Live":"Offline"})]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"User:"}),e.jsxs("select",{value:h,onChange:s=>N(s.target.value),className:"px-3 py-2 border rounded-lg bg-white text-sm sm:text-base",children:[e.jsx("option",{value:"",children:"Select user..."}),B.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Week:"}),e.jsx("select",{value:b,onChange:s=>l(parseInt(s.target.value)),className:"px-3 py-2 border rounded-lg bg-white text-sm sm:text-base",children:Array.from({length:18},(s,t)=>t+1).map(s=>e.jsxs("option",{value:s,children:["Week ",s]},s))})]}),e.jsxs("div",{className:"flex bg-gray-100 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>E("list"),className:`px-3 py-1 rounded text-xs font-medium transition-colors ${k==="list"?"bg-white text-gray-900 shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:"List"}),e.jsx("button",{onClick:()=>E("compact"),className:`px-3 py-1 rounded text-xs font-medium transition-colors ${k==="compact"?"bg-white text-gray-900 shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:"Compact"})]}),e.jsxs("div",{className:"hidden sm:flex items-center space-x-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${g.isConnected?"bg-green-500":"bg-red-500"}`}),e.jsx("span",{className:"text-xs text-gray-500",children:g.isConnected?"Live":"Offline"})]})]})]})}),m&&R.length>0&&e.jsx(D,{games:R,className:"sticky top-20 z-5"}),i.some(s=>s.isLockingSoon&&!s.isLocked)&&e.jsxs("div",{className:"bg-gradient-to-r from-orange-50 to-red-50 border border-orange-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("svg",{className:"w-5 h-5 text-orange-600 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("h3",{className:"text-lg font-semibold text-orange-800",children:"Games Locking Soon!"})]}),e.jsx("div",{className:"space-y-2",children:i.filter(s=>s.isLockingSoon&&!s.isLocked).map(s=>{var t,a;return e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("span",{className:"font-medium",children:[(t=s.awayTeam)==null?void 0:t.abbreviation," @ ",(a=s.homeTeam)==null?void 0:a.abbreviation]}),s.timeToLock&&e.jsxs("span",{className:"text-orange-600 font-mono",children:[Math.floor(s.timeToLock/(1e3*60)),"m remaining"]})]},s.id)})})]}),i.length===0?e.jsxs("div",{className:"text-center py-12 bg-white rounded-lg border",children:[e.jsx("svg",{className:"w-16 h-16 text-gray-300 mx-auto mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9.172 16.172a4 4 0 015.656 0M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("p",{className:"text-lg text-gray-500 mb-2",children:"No games found"}),e.jsxs("p",{className:"text-sm text-gray-400",children:["Week ",b,", ",u]})]}):e.jsx("div",{className:`grid gap-4 ${k==="compact"?"sm:grid-cols-2 lg:grid-cols-3":""}`,children:i.map(s=>e.jsx(F,{game:s,userHasPick:d.has(s.id),userPickTeamId:d.get(s.id),onPickSubmit:M,lockOffsetMinutes:x,isAutoPickEnabled:S,compactMode:k==="compact",className:"hover:shadow-lg transition-shadow duration-200"},s.id))}),e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-green-50 rounded-lg border p-6",children:[e.jsxs("h3",{className:"text-xl font-semibold mb-4 flex items-center",children:[e.jsx("svg",{className:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 00-2-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v4a2 2 0 01-2 2H9z"})}),"Week ",b," Summary"]}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:i.length}),e.jsx("div",{className:"text-sm text-gray-500",children:"Total Games"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:I.upcoming}),e.jsx("div",{className:"text-sm text-gray-500",children:"Open for Picks"}),e.jsx(z,{status:"upcoming",size:"small",className:"mt-1"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-600",children:I.locked}),e.jsx("div",{className:"text-sm text-gray-500",children:"Locked"}),e.jsx(z,{status:"locked",size:"small",className:"mt-1"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:I.final}),e.jsx("div",{className:"text-sm text-gray-500",children:"Final"}),e.jsx(z,{status:"final",size:"small",className:"mt-1"})]})]}),m&&e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-4 text-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-semibold text-green-600",children:d.size}),e.jsx("div",{className:"text-xs text-gray-500",children:"Your Picks"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-semibold text-orange-600",children:i.filter(s=>!s.isCompleted).length-d.size}),e.jsx("div",{className:"text-xs text-gray-500",children:"Remaining"})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1",children:[e.jsxs("div",{className:"text-lg font-semibold text-blue-600",children:[i.length>0?Math.round(d.size/i.length*100):0,"%"]}),e.jsx("div",{className:"text-xs text-gray-500",children:"Complete"})]})]})})]})]})}export{_ as GamesPage};
