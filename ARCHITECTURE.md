# NFL Pick'em App - Architecture & Technical Documentation

**Last Updated:** November 20, 2025
**Status:** Production (Live at https://pickem.cyberlees.dev)

---

## Table of Contents

1. [Project Structure & Architecture](#1-project-structure--architecture)
2. [API Contracts & Data Models](#2-api-contracts--data-models)
3. [Tech Stack](#3-tech-stack)
4. [Key Patterns & Conventions](#4-key-patterns--conventions)
5. [Integration Points](#5-integration-points)
6. [Dependencies & Configuration](#6-dependencies--configuration)
7. [Component Structure](#7-component-structure-react)
8. [Build Configuration](#8-build-configuration)
9. [Deployment Architecture](#9-deployment-architecture)
10. [Security Features](#10-security-features)

---

## 1. Project Structure & Architecture

### Overall Organization

```
nfl-pickem-app/
├── src/
│   ├── components/          # React UI components (12 main + mobile variants)
│   ├── components/mobile/   # Mobile-optimized UI components
│   ├── hooks/              # Custom React hooks
│   ├── lib/                # Library code (database manager, event system)
│   ├── pages/              # Page components (HomePage, GamesPage, LeaderboardPage)
│   ├── styles/             # Global styles
│   ├── types/              # TypeScript type definitions
│   ├── utils/              # Utility functions (API client, time utilities)
│   ├── App.tsx             # Main React app router
│   ├── main.tsx            # Vite entry point
│   ├── index.css           # Global Tailwind styles
│   └── worker.ts           # Cloudflare Workers API (2,765 lines)
├── lib/
│   └── db-workers.ts       # D1 Database manager with Zod schemas
├── migrations/             # Database migration scripts
├── tests/                  # Comprehensive test suites
├── public/                 # Static assets
├── dist/                   # Built frontend (Vite output)
├── schema.sql              # D1 database schema
├── wrangler-workers.toml   # Workers deployment configuration
├── vite.config.ts          # Vite build configuration
├── tailwind.config.ts      # Tailwind CSS theme
├── tsconfig.json           # TypeScript configuration
└── package.json            # Dependencies and scripts
```

### Frontend Architecture (React + Vite)

- **Build Tool**: Vite with hot module replacement (HMR)
- **Routing**: React Router v6 with lazy-loaded pages
- **State Management**: React hooks (useState, useCallback, useRef)
- **Styling**: Tailwind CSS with custom theme colors
- **PWA**: Vite PWA plugin with Workbox service worker caching
- **Code Splitting**: Manual chunks for vendor, UI, and route-specific bundles

### Backend Architecture (Cloudflare Workers)

- **Runtime**: Cloudflare Workers with Node.js compatibility
- **Database**: Cloudflare D1 (SQLite-compatible)
- **Authentication**: Custom JWT with bcryptjs hashing
- **Cron**: Scheduled tasks every 15 minutes
- **External APIs**: ESPN API, The Odds API
- **Real-time**: Server-Sent Events (SSE) with polling fallback

### Database Architecture (D1 SQLite)

**Core Tables:**

- `users` - Authentication and profile data
- `teams` - 32 NFL teams with colors and division info
- `games` - Game schedules with odds and scores (weeks 1-18, 2025 season)
- `picks` - User predictions with lock status and scoring
- `game_locks` - Game lock tracking for time-lock system
- `system_logs` - Automation event logging
- `scheduler_logs` - Cron job execution records

---

## 2. API Contracts & Data Models

### TypeScript Interfaces

#### Core Models (src/types/api.ts)

```typescript
interface Team {
  id: string;
  name: string;
  abbreviation: string;
  conference?: string;
  division?: string;
  primaryColor?: string;
  secondaryColor?: string;
  logoUrl?: string;
}

interface Game {
  id: string;
  week: number;
  season: number;
  homeTeamId: string;
  awayTeamId: string;
  gameDate: string;
  lockTime?: string;
  status?: 'upcoming' | 'locked' | 'in_progress' | 'final';
  homeScore?: number;
  awayScore?: number;
  spread?: number;
  overUnder?: number;
  isCompleted: boolean;
  winnerTeamId?: string;
  homeTeam: Team;
  awayTeam: Team;
}

interface Pick {
  id: string;
  userId: string;
  gameId: string;
  teamId: string;
  isLocked: boolean;
  lockedAt?: string;
  autoGenerated: boolean;
  points?: number;
}

interface Leaderboard {
  week: number;
  season: number;
  entries: LeaderboardEntry[];
  totalGames: number;
  completedGames: number;
}

interface LeaderboardEntry {
  user: User;
  position: number;
  points: number;
  weeklyPoints?: number;
  totalSeasonPoints?: number;
  winPercentage: number;
}

interface GameStatus extends Game {
  isLocked: boolean;
  timeUntilLock: number; // milliseconds
  isLockingSoon?: boolean;
}
```

### API Endpoints

#### Authentication (src/worker.ts:299-380)

```http
POST /api/auth/register
Content-Type: application/json

Request:  { email: string, password: string, name?: string }
Response: { user: User, token: string }

POST /api/auth/signin
Content-Type: application/json

Request:  { email: string, password: string }
Response: { user: User, token: string }

GET /api/auth/session
Authorization: Bearer {token}

Response: { user: User }
```

#### Games & Time-Lock System (src/worker.ts:206-238)

```http
GET /api/games?week={week}&season={season}
Response: Game[]

GET /api/games/status?week={week}&season={season}
Response: {
  games: GameStatus[],
  count: number,
  timestamp: string
}

POST /api/games/update-locks
Response: {
  success: boolean,
  newlyLockedGames: number,
  gameIds: string[],
  timestamp: string
}

GET /api/games/live-scores?week={week}&season={season}
Response: {
  liveGames: Game[],
  lastUpdated: string
}
```

#### Picks & Scoring (src/worker.ts:240-296)

```http
GET /api/picks
Authorization: Bearer {token}
Response: { picks: Pick[] }

POST /api/picks
Content-Type: application/json
Authorization: Bearer {token}

Request:  { userId: string, gameId: string, teamId: string }
Response: {
  success: boolean,
  pick: Pick,
  timeUntilLock: number
}

POST /api/picks/auto-generate
Response: {
  success: boolean,
  autoGeneratedCount: number,
  gamesProcessed: number,
  details: AutoGenDetail[]
}

GET /api/picks/live-status?userId={userId}&week={week}&season={season}
Authorization: Bearer {token}
Response: { picks: UserPick[] }
```

#### Leaderboard (src/worker.ts:383-437)

```http
GET /api/leaderboard?week={week}&season={season}
Response: Leaderboard

GET /api/leaderboard/live?week={week}&season={season}
Response: {
  leaderboard: Leaderboard,
  timestamp: string
}
```

#### Data Sync (src/worker.ts:441-470)

```http
POST /api/odds/sync
X-API-Key: ESPN-SYSTEM-SYNC-2025

Response: {
  gamesInserted: number,
  weekBreakdown: Record<number, number>,
  dataSources: Record<string, number>,
  stats: SyncStats
}
```

#### System Operations (src/worker.ts:509-641)

```http
GET /api/system/logs?limit={limit}&type={type}&status={status}
Response: { logs: SystemLog[], count: number }

GET /api/system/metrics?hours={hours}
Response: {
  metrics: SystemMetrics,
  timeframe: string,
  cutoffTime: string
}

POST /api/system/migrate
X-API-Key: ESPN-SYSTEM-SYNC-2025

Response: {
  success: boolean,
  message: string,
  results: MigrationResult[]
}

POST /api/scores/update
Response: {
  success: boolean,
  message: string,
  timestamp: string
}
```

#### Real-Time Events (src/worker.ts:717-792)

```http
GET /api/events/stream
Authorization: Bearer {token}
Content-Type: text/event-stream

Response: Server-Sent Events stream

GET /api/events/poll?lastEventId={id}
Authorization: Bearer {token}

Response: {
  events: RealTimeEvent[],
  lastEventId: number,
  hasMore: boolean
}

POST /api/events
Content-Type: application/json

Request:  {
  type: string,
  payload: any,
  scope: string,
  expiresInMinutes?: number
}
Response: { success: boolean, event: RealTimeEvent }
```

#### Automation (src/worker.ts:644-680)

```http
POST /api/automation/trigger
Content-Type: application/json

Request:  { dryRun?: boolean }
Response: {
  success: boolean,
  message: string,
  executionId: string,
  timestamp: string
}
```

### Database Schema

#### Users Table

```sql
CREATE TABLE users (
  id TEXT PRIMARY KEY,
  email TEXT NOT NULL UNIQUE,
  name TEXT,
  passwordHash TEXT,
  passwordSalt TEXT,
  role TEXT DEFAULT 'user',
  createdAt TEXT NOT NULL,
  updatedAt TEXT NOT NULL
);

CREATE INDEX idx_users_email ON users(email);
```

#### Teams Table

```sql
CREATE TABLE teams (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  abbreviation TEXT NOT NULL UNIQUE,
  conference TEXT,
  division TEXT,
  primaryColor TEXT,
  secondaryColor TEXT,
  logoUrl TEXT
);
```

#### Games Table

```sql
CREATE TABLE games (
  id TEXT PRIMARY KEY,
  espnId TEXT,
  week INTEGER NOT NULL,
  season INTEGER NOT NULL,
  homeTeamId TEXT NOT NULL,
  awayTeamId TEXT NOT NULL,
  gameDate TEXT NOT NULL,
  lockTime TEXT NOT NULL,
  status TEXT DEFAULT 'upcoming',
  homeScore INTEGER,
  awayScore INTEGER,
  spread REAL,
  overUnder REAL,
  isCompleted BOOLEAN DEFAULT 0,
  winnerTeamId TEXT,
  oddsProvider TEXT,
  lastSyncedAt TEXT,
  FOREIGN KEY (homeTeamId) REFERENCES teams(id),
  FOREIGN KEY (awayTeamId) REFERENCES teams(id),
  FOREIGN KEY (winnerTeamId) REFERENCES teams(id)
);

CREATE INDEX idx_games_week_season ON games(week, season);
CREATE INDEX idx_games_lock_time ON games(lockTime);
CREATE INDEX idx_games_status ON games(status);
```

#### Picks Table

```sql
CREATE TABLE picks (
  id TEXT PRIMARY KEY,
  userId TEXT NOT NULL,
  gameId TEXT NOT NULL,
  teamId TEXT NOT NULL,
  confidence INTEGER,
  isCorrect BOOLEAN,
  points INTEGER DEFAULT 0,
  lockedAt TEXT,
  isLocked BOOLEAN DEFAULT 0,
  autoGenerated BOOLEAN DEFAULT 0,
  createdAt TEXT NOT NULL,
  updatedAt TEXT NOT NULL,
  UNIQUE(userId, gameId),
  FOREIGN KEY (userId) REFERENCES users(id),
  FOREIGN KEY (gameId) REFERENCES games(id),
  FOREIGN KEY (teamId) REFERENCES teams(id)
);

CREATE INDEX idx_picks_user_game ON picks(userId, gameId);
CREATE INDEX idx_picks_is_locked ON picks(isLocked);
CREATE INDEX idx_picks_game_id ON picks(gameId);
```

#### Game Locks Table

```sql
CREATE TABLE game_locks (
  id TEXT PRIMARY KEY,
  gameId TEXT NOT NULL UNIQUE,
  lockedAt TEXT NOT NULL,
  lockReason TEXT,
  FOREIGN KEY (gameId) REFERENCES games(id)
);

CREATE INDEX idx_game_locks_locked_at ON game_locks(lockedAt);
```

#### System Logs Table

```sql
CREATE TABLE system_logs (
  id TEXT PRIMARY KEY,
  eventType TEXT NOT NULL,
  status TEXT NOT NULL,
  message TEXT,
  details TEXT,
  createdAt TEXT NOT NULL
);

CREATE INDEX idx_system_logs_created_at ON system_logs(createdAt);
CREATE INDEX idx_system_logs_event_type ON system_logs(eventType);
```

### Event System Types (src/types/events.ts)

```typescript
type RealTimeEvent =
  | GameLockEvent
  | ScoreUpdateEvent
  | PickSubmittedEvent
  | AutoPickGeneratedEvent
  | GameCompletedEvent
  | LeaderboardUpdateEvent;

interface GameLockEvent {
  type: 'GameLockEvent';
  payload: {
    gameId: string;
    lockTime: string;
    teamsAffected: { homeTeam: Team; awayTeam: Team };
  };
  timestamp: string;
  scope: 'user' | 'global';
}

interface ScoreUpdateEvent {
  type: 'ScoreUpdateEvent';
  payload: {
    gameId: string;
    homeScore: number;
    awayScore: number;
    status: string;
    quarter?: string;
    timeRemaining?: string;
  };
  timestamp: string;
  scope: 'global';
}

interface PickSubmittedEvent {
  type: 'PickSubmittedEvent';
  payload: {
    userId: string;
    gameId: string;
    teamId: string;
    timeUntilLock: number;
  };
  timestamp: string;
  scope: 'user';
}
```

---

## 3. Tech Stack

### Frontend Dependencies

```json
{
  "react": "^18.2.0",              // UI framework
  "react-dom": "^18.2.0",          // React DOM rendering
  "react-router-dom": "^6.20.1",   // Client-side routing
  "@heroicons/react": "^2.2.0",    // Icon library
  "tailwindcss-animate": "^1.0.7", // Animation utilities
  "zod": "^3.25.76"                // Runtime schema validation
}
```

### Backend Dependencies

```json
{
  "bcryptjs": "^3.0.2",                    // Password hashing
  "jose": "^6.1.0",                        // JWT creation/verification
  "@cloudflare/workers-types": "^4.x"     // Worker type definitions
}
```

### Development Tools

```json
{
  "vite": "^5.0.8",                  // Build tool & dev server
  "@vitejs/plugin-react": "^4.2.1",  // React plugin for Vite
  "vite-plugin-pwa": "^1.0.3",       // PWA support
  "typescript": "^5.2.2",            // Type checking
  "tailwindcss": "^3.3.6",           // CSS framework
  "wrangler": "^4.34.0",             // Cloudflare CLI
  "@playwright/test": "^1.40.0",     // E2E testing
  "vitest": "^1.0.4",                // Unit testing
  "eslint": "^8.55.0"                // Linting
}
```

### Build & Deployment Stack

- **Frontend Build**: Vite → `/dist` directory
- **Frontend Hosting**: Cloudflare Pages
- **Backend Build**: TypeScript compilation with Wrangler
- **Backend Hosting**: Cloudflare Workers
- **Database**: Cloudflare D1 (SQLite)
- **Package Manager**: npm
- **Version Control**: Git

---

## 4. Key Patterns & Conventions

### Authentication & Authorization

#### JWT Token Creation

```typescript
// src/worker.ts:869-875
async function createJWT(payload: any, env: Env): Promise<string> {
  const secret = new TextEncoder().encode(env.JWT_SECRET || 'dev-secret')
  return new SignJWT(payload)
    .setProtectedHeader({ alg: 'HS256' })
    .setExpirationTime('24h')
    .sign(secret)
}
```

#### Token Verification

```typescript
// src/worker.ts:877-885
async function verifyJWT(token: string, env: Env): Promise<any> {
  const secret = new TextEncoder().encode(env.JWT_SECRET || 'dev-secret')
  const { payload } = await jwtVerify(token, secret)
  return payload
}
```

**Authentication Flow:**

1. User registers with email/password → password hashed with bcryptjs (12 rounds)
2. Credentials stored in D1 database
3. Sign-in returns JWT token (24-hour expiration)
4. Token sent in `Authorization: Bearer {token}` header for protected routes
5. Current user retrieved from JWT payload

### API Response Patterns

```typescript
// Standard response wrapper
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: string;
}

// Success response
return new Response(JSON.stringify({
  success: true,
  data: result
}), {
  status: 200,
  headers: corsHeaders
})

// Error response
return new Response(JSON.stringify({
  success: false,
  error: message
}), {
  status: 400,
  headers: corsHeaders
})
```

### Error Handling Strategy

```typescript
// All endpoints wrapped in try-catch
try {
  // Endpoint logic
  const result = await processRequest(request, env)
  return successResponse(result)
} catch (error) {
  console.error('Endpoint error:', error)
  return errorResponse(error.message, 500)
}

// Client-side error boundaries
class ErrorBoundary extends React.Component {
  componentDidCatch(error, errorInfo) {
    console.error('React error:', error, errorInfo)
    this.setState({ hasError: true })
  }
}
```

### Naming Conventions

- **Files**: PascalCase for components (`GameCard.tsx`), camelCase for utils (`apiClient.ts`)
- **Functions**: camelCase (`fetchGames`, `createPick`)
- **Constants**: UPPER_SNAKE_CASE (`API_BASE_URL`, `JWT_SECRET`)
- **TypeScript Types**: PascalCase (`Game`, `Pick`, `LeaderboardEntry`)
- **CSS Classes**: kebab-case Tailwind utilities (`flex-col`, `bg-blue-500`)
- **Database Columns**: camelCase in TypeScript, snake_case in SQL schema

### Time-Lock System Patterns

```typescript
// Calculate remaining time until lock
const timeUntilLock = Math.max(0, lockTime.getTime() - Date.now())

// Check if game is locked
const isGameLocked = Date.now() >= new Date(game.lockTime).getTime()

// Format duration for display
const formatDuration = (seconds: number): string => {
  const h = Math.floor(seconds / 3600)
  const m = Math.floor((seconds % 3600) / 60)
  const s = seconds % 60
  return h > 0 ? `${h}h ${m}m` : m > 0 ? `${m}m ${s}s` : `${s}s`
}

// Real-time countdown with useEffect
useEffect(() => {
  const interval = setInterval(() => {
    setTimeRemaining(calculateTimeRemaining())
  }, 1000)
  return () => clearInterval(interval)
}, [game.lockTime])
```

### Component Composition Pattern

```typescript
// Functional component with hooks
export const GameCard: React.FC<GameCardProps> = ({
  game,
  onPickSubmit,
  className = ''
}) => {
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [localPick, setLocalPick] = useState<string | null>(null)

  const handlePickSubmit = useCallback(async (teamId: string) => {
    setIsSubmitting(true)
    try {
      await onPickSubmit(game.id, teamId)
      setLocalPick(teamId)
    } catch (error) {
      console.error('Pick submission failed:', error)
    } finally {
      setIsSubmitting(false)
    }
  }, [game.id, onPickSubmit])

  return (
    <div className={`game-card ${className}`}>
      {/* Component JSX */}
    </div>
  )
}
```

### Data Validation with Zod

```typescript
// lib/db-workers.ts - Schema validation
import { z } from 'zod'

const GameSchema = z.object({
  id: z.string().uuid(),
  week: z.number().int().min(1).max(18),
  season: z.number().int(),
  homeTeamId: z.string().uuid(),
  awayTeamId: z.string().uuid(),
  gameDate: z.string(),
  lockTime: z.string(),
  status: z.enum(['upcoming', 'locked', 'in_progress', 'final']),
  homeScore: z.number().nullable(),
  awayScore: z.number().nullable(),
  spread: z.number().nullable(),
  overUnder: z.number().nullable(),
  isCompleted: z.boolean()
})

// Validate database query results
const games = GameSchema.array().parse(rawGames)
```

### CORS Headers Configuration

```typescript
// src/worker.ts:46-54
const corsHeaders = {
  'Access-Control-Allow-Origin': 'https://pickem.cyberlees.dev',
  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-API-Key',
  'Access-Control-Max-Age': '86400',
  'Content-Type': 'application/json'
}

// Handle OPTIONS preflight
if (request.method === 'OPTIONS') {
  return new Response(null, { headers: corsHeaders })
}
```

---

## 5. Integration Points

### ESPN API Integration

#### Fetch Games for Entire Season

```typescript
// src/worker.ts:1419-1474
async function fetchESPNGamesForWeek(
  week: number,
  season: number
): Promise<any[]> {
  const url = 'https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard'
  const params = `?seasontype=2&week=${week}&dates=${season}`

  const response = await fetch(url + params)
  if (!response.ok) {
    throw new Error(`ESPN API error: ${response.status}`)
  }

  const data = await response.json()

  return data.events.map((event: any) => {
    const competition = event.competitions[0]
    const homeTeam = competition.competitors.find((c: any) => c.homeAway === 'home')
    const awayTeam = competition.competitors.find((c: any) => c.homeAway === 'away')
    const odds = competition.odds?.[0]

    return {
      espnId: event.id,
      week,
      season,
      homeTeamAbbr: homeTeam.team.abbreviation,
      awayTeamAbbr: awayTeam.team.abbreviation,
      gameDate: event.date,
      status: competition.status.type.name,
      homeScore: parseInt(homeTeam.score) || null,
      awayScore: parseInt(awayTeam.score) || null,
      spread: odds?.details ? parseFloat(odds.details) : null,
      overUnder: odds?.overUnder ? parseFloat(odds.overUnder) : null
    }
  })
}

// Loop through all weeks
async function fetchAllWeeks(season: number): Promise<any[]> {
  const allGames = []
  for (let week = 1; week <= 18; week++) {
    const games = await fetchESPNGamesForWeek(week, season)
    allGames.push(...games)
    await new Promise(resolve => setTimeout(resolve, 100)) // Rate limiting
  }
  return allGames
}
```

**Data Synced from ESPN:**

- All 199 games for 2025 season (weeks 1-18)
- Game dates/times (lockTime = game start time)
- Spreads and over/under odds (when available)
- Real-time score updates during games
- Game status transitions (upcoming → locked → in_progress → final)

### The Odds API Integration

```typescript
// src/worker.ts:1476-1520
async function fetchOddsApiGames(env: Env): Promise<any[]> {
  const apiKey = env.THE_ODDS_API_KEY
  const baseUrl = env.THE_ODDS_API_BASE_URL || 'https://api.the-odds-api.com/v4'

  const url = `${baseUrl}/sports/americanfootball_nfl/odds`
  const params = new URLSearchParams({
    apiKey,
    regions: 'us',
    markets: 'spreads,totals',
    oddsFormat: 'american'
  })

  const response = await fetch(`${url}?${params}`)
  if (!response.ok) {
    throw new Error(`Odds API error: ${response.status}`)
  }

  const data = await response.json()

  return data.map((game: any) => {
    const spreadsMarket = game.bookmakers?.[0]?.markets?.find((m: any) => m.key === 'spreads')
    const totalsMarket = game.bookmakers?.[0]?.markets?.find((m: any) => m.key === 'totals')

    return {
      homeTeam: game.home_team,
      awayTeam: game.away_team,
      gameDate: game.commence_time,
      spread: spreadsMarket?.outcomes?.[0]?.point,
      overUnder: totalsMarket?.outcomes?.[0]?.point
    }
  })
}
```

**When Odds API is Used:**

- Supplements ESPN data when spreads/odds are missing
- Fallback for games without ESPN odds data
- Provides alternative data source for betting lines

### Cloudflare Services Integration

#### Cloudflare Workers

```toml
# wrangler-workers.toml
name = "nfl-pickem-app-production"
main = "src/worker.ts"
compatibility_date = "2024-01-01"
node_compat = true

[[d1_databases]]
binding = "DB"
database_name = "nfl-pickem-db"
database_id = "your-database-id"

[triggers]
crons = ["*/15 * * * *"]  # Every 15 minutes

[[routes]]
pattern = "pickem.cyberlees.dev/*"
custom_domain = true
```

#### Cloudflare D1 Database Access

```typescript
// Access via Workers binding
export default {
  async fetch(request: Request, env: Env) {
    const db = env.DB  // D1 database binding

    // Execute prepared statement
    const { results } = await db.prepare(
      'SELECT * FROM games WHERE week = ? AND season = ?'
    ).bind(week, season).all()

    return new Response(JSON.stringify(results))
  }
}
```

#### Cloudflare Pages Deployment

```yaml
# Auto-detected by Cloudflare Pages
Build command: npm run build
Build output directory: /dist
Root directory: /
Node version: 18
```

### Frontend-Backend Communication

#### ApiClient Pattern

```typescript
// src/utils/apiClient.ts
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL ||
  'https://nfl-pickem-app-production.cybermattlee-llc.workers.dev'

class ApiClient {
  private static getAuthHeader(token?: string): HeadersInit {
    return token ? { 'Authorization': `Bearer ${token}` } : {}
  }

  static async get<T>(endpoint: string, token?: string): Promise<ApiResponse<T>> {
    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        ...this.getAuthHeader(token)
      }
    })

    const data = await response.json()
    return { success: response.ok, data }
  }

  static async post<T>(
    endpoint: string,
    body: any,
    token?: string
  ): Promise<ApiResponse<T>> {
    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...this.getAuthHeader(token)
      },
      body: JSON.stringify(body)
    })

    const data = await response.json()
    return { success: response.ok, data }
  }

  // Specific endpoint methods
  static async getGames(week: number, season: number) {
    return this.get<Game[]>(`/api/games?week=${week}&season=${season}`)
  }

  static async submitPick(pick: PickSubmission, token: string) {
    return this.post<Pick>('/api/picks', pick, token)
  }

  static async getLeaderboard(week: number, season: number) {
    return this.get<Leaderboard>(`/api/leaderboard?week=${week}&season=${season}`)
  }
}

export default ApiClient
```

### Real-Time Updates System

#### Server-Sent Events (SSE)

```typescript
// src/worker.ts:717-756 - SSE endpoint
async function handleSSEStream(request: Request, env: Env): Promise<Response> {
  const userId = await getUserIdFromToken(request, env)

  const { readable, writable } = new TransformStream()
  const writer = writable.getWriter()
  const encoder = new TextEncoder()

  // Send initial connection message
  await writer.write(encoder.encode('data: {"type":"connected"}\n\n'))

  // Keep connection alive
  const keepAliveInterval = setInterval(async () => {
    try {
      await writer.write(encoder.encode(': keepalive\n\n'))
    } catch {
      clearInterval(keepAliveInterval)
    }
  }, 30000)

  // Send real-time events
  const eventInterval = setInterval(async () => {
    const events = await getRecentEvents(env, userId)
    for (const event of events) {
      await writer.write(encoder.encode(`data: ${JSON.stringify(event)}\n\n`))
    }
  }, 5000)

  return new Response(readable, {
    headers: {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive'
    }
  })
}
```

#### Polling Fallback

```typescript
// src/worker.ts:758-792 - Polling endpoint
async function handleEventPoll(request: Request, env: Env): Promise<Response> {
  const url = new URL(request.url)
  const lastEventId = parseInt(url.searchParams.get('lastEventId') || '0')
  const userId = await getUserIdFromToken(request, env)

  const events = await getEventsSince(env, lastEventId, userId)

  return new Response(JSON.stringify({
    events,
    lastEventId: events.length > 0 ? events[events.length - 1].id : lastEventId,
    hasMore: events.length >= 50
  }), {
    headers: corsHeaders
  })
}
```

#### Custom Hook Integration

```typescript
// src/hooks/useRealTimeUpdates.ts
export const useRealTimeUpdates = (userId: string, token: string) => {
  const [events, setEvents] = useState<RealTimeEvent[]>([])
  const [isConnected, setIsConnected] = useState(false)
  const eventSourceRef = useRef<EventSource | null>(null)
  const pollingIntervalRef = useRef<NodeJS.Timeout | null>(null)

  useEffect(() => {
    // Try SSE first
    const eventSource = new EventSource(
      `${API_BASE_URL}/api/events/stream`,
      { headers: { 'Authorization': `Bearer ${token}` } }
    )

    eventSource.onopen = () => setIsConnected(true)
    eventSource.onerror = () => {
      setIsConnected(false)
      // Fall back to polling
      startPolling()
    }

    eventSource.onmessage = (event) => {
      const data = JSON.parse(event.data)
      setEvents(prev => [...prev, data])
    }

    eventSourceRef.current = eventSource

    return () => {
      eventSource.close()
      if (pollingIntervalRef.current) {
        clearInterval(pollingIntervalRef.current)
      }
    }
  }, [userId, token])

  const startPolling = () => {
    let lastEventId = 0
    pollingIntervalRef.current = setInterval(async () => {
      const response = await fetch(
        `${API_BASE_URL}/api/events/poll?lastEventId=${lastEventId}`,
        { headers: { 'Authorization': `Bearer ${token}` } }
      )
      const data = await response.json()

      if (data.events.length > 0) {
        setEvents(prev => [...prev, ...data.events])
        lastEventId = data.lastEventId
      }
    }, 10000) // Poll every 10 seconds
  }

  return { events, isConnected }
}
```

---

## 6. Dependencies & Configuration

### Environment Variables

#### Development (.env.local)

```bash
VITE_API_BASE_URL=http://localhost:8787
VITE_NODE_ENV=development
```

#### Production (Cloudflare Workers)

```toml
# wrangler-workers.toml
[env.production.vars]
NODE_ENV = "production"
CURRENT_NFL_SEASON = "2025"
CURRENT_NFL_WEEK = "1"
THE_ODDS_API_BASE_URL = "https://api.the-odds-api.com/v4"

# Secrets (set via: wrangler secret put SECRET_NAME)
# THE_ODDS_API_KEY
# JWT_SECRET
```

### External API Dependencies

#### ESPN API (Free, No Key Required)

```
Base URL: https://site.api.espn.com/apis/site/v2/sports/football/nfl
Endpoints:
  - /scoreboard?seasontype=2&week={week}&dates={season}
Rate Limit: No official limit, recommend 100ms between requests
Returns: Game schedules, scores, team data, live updates
Usage: Primary data source for all games and scores
```

#### The Odds API

```
Base URL: https://api.the-odds-api.com/v4
Endpoints:
  - /sports/americanfootball_nfl/odds?apiKey={key}&markets=spreads,totals
Rate Limit: Based on subscription tier
Returns: Betting odds, spreads, moneylines, over/unders
Usage: Supplement ESPN data for missing odds
```

### Cloudflare Service Dependencies

```
Cloudflare Workers
├── Runtime: Node.js 18+ compatible
├── Bindings: D1 database (env.DB)
├── Secrets: JWT_SECRET, THE_ODDS_API_KEY
├── Triggers: Cron (*/15 * * * *)
└── Custom Domain: pickem.cyberlees.dev

Cloudflare D1
├── Type: SQLite database
├── Storage: Automatic backups enabled
├── Access: Via prepared statements
└── Scaling: Automatic with Workers platform

Cloudflare Pages
├── Framework: Static site (Vite build output)
├── Build Command: npm run build
├── Output Directory: /dist
├── Domains: pickem.cyberlees.dev
└── CI/CD: Auto-deploy on git push to main
```

### NPM Scripts Reference

#### Development

```bash
npm run dev                    # Start Vite dev server (port 3000)
npm run workers:dev           # Start Workers dev server (port 8787)
npm run test                  # Run Vitest unit tests
npm run test:e2e              # Run Playwright e2e tests
npm run lint                  # Run ESLint
npm run type-check            # TypeScript type checking
```

#### Build & Deploy

```bash
npm run build                 # Build frontend → /dist
npm run workers:deploy        # Deploy Workers to production
npm run workers:deploy-prod   # Deploy with --env production
npm run prod:deploy           # Build + deploy + health check
npm run preview               # Preview production build locally
```

#### Database Operations

```bash
# Execute SQL on remote database
wrangler d1 execute nfl-pickem-db --remote --command="SELECT * FROM games LIMIT 5;"

# Check database schema
wrangler d1 execute nfl-pickem-db --remote --command="PRAGMA table_info(games);"

# List all users
wrangler d1 execute nfl-pickem-db --remote --command="SELECT id, email, name FROM users;"

# Check production database status
npm run prod:db:status
```

#### Data Sync

```bash
# Development sync
npm run odds:sync

# Production sync (requires API key)
curl -X POST https://nfl-pickem-app-production.cybermattlee-llc.workers.dev/api/odds/sync \
  -H "X-API-Key: ESPN-SYSTEM-SYNC-2025"

# Production sync script
npm run prod:sync
```

#### Monitoring & Maintenance

```bash
# Full production health check
npm run prod:monitor

# View system logs
curl https://nfl-pickem-app-production.cybermattlee-llc.workers.dev/api/system/logs?limit=50

# View system metrics
curl https://nfl-pickem-app-production.cybermattlee-llc.workers.dev/api/system/metrics?hours=24

# Trigger automation manually
curl -X POST https://nfl-pickem-app-production.cybermattlee-llc.workers.dev/api/automation/trigger
```

---

## 7. Component Structure (React)

### Page Components

#### HomePage (src/pages/HomePage.tsx)

```typescript
// Week selector, user selector, games with picks
export const HomePage: React.FC = () => {
  const [selectedWeek, setSelectedWeek] = useState(1)
  const [selectedUser, setSelectedUser] = useState<string | null>(null)
  const [games, setGames] = useState<Game[]>([])
  const [picks, setPicks] = useState<Record<string, Pick>>({})

  useEffect(() => {
    loadGames(selectedWeek, CURRENT_SEASON)
    if (selectedUser) {
      loadPicks(selectedUser, selectedWeek)
    }
  }, [selectedWeek, selectedUser])

  return (
    <div className="home-page">
      <WeekSelector value={selectedWeek} onChange={setSelectedWeek} />
      <UserSelector value={selectedUser} onChange={setSelectedUser} />
      <GamesList games={games} picks={picks} onPickSubmit={handlePickSubmit} />
    </div>
  )
}
```

#### GamesPage (src/pages/GamesPage.tsx)

```typescript
// Games with time-lock status and real-time countdowns
export const GamesPage: React.FC = () => {
  const [gameStatuses, setGameStatuses] = useState<GameStatus[]>([])
  const { events, isConnected } = useRealTimeUpdates(userId, token)

  useEffect(() => {
    loadGameStatuses()

    // Update every second for countdowns
    const interval = setInterval(() => {
      setGameStatuses(prev => prev.map(updateTimeUntilLock))
    }, 1000)

    return () => clearInterval(interval)
  }, [])

  // Handle real-time lock events
  useEffect(() => {
    const lockEvents = events.filter(e => e.type === 'GameLockEvent')
    if (lockEvents.length > 0) {
      refreshGameStatuses()
    }
  }, [events])

  return (
    <div className="games-page">
      {gameStatuses.map(game => (
        <GameStatusCard
          key={game.id}
          game={game}
          showCountdown
        />
      ))}
    </div>
  )
}
```

#### LeaderboardPage (src/pages/LeaderboardPage.tsx)

```typescript
// User rankings with seasonal stats
export const LeaderboardPage: React.FC = () => {
  const [leaderboard, setLeaderboard] = useState<Leaderboard | null>(null)
  const [selectedWeek, setSelectedWeek] = useState<number | 'season'>('season')
  const { events } = useRealTimeUpdates(userId, token)

  useEffect(() => {
    loadLeaderboard(selectedWeek)
  }, [selectedWeek])

  // Handle real-time score updates
  useEffect(() => {
    const scoreEvents = events.filter(e =>
      e.type === 'ScoreUpdateEvent' || e.type === 'GameCompletedEvent'
    )
    if (scoreEvents.length > 0) {
      refreshLeaderboard()
    }
  }, [events])

  return (
    <div className="leaderboard-page">
      <WeekSelector
        value={selectedWeek}
        onChange={setSelectedWeek}
        includeSeasonOption
      />
      <LeaderboardTable leaderboard={leaderboard} />
    </div>
  )
}
```

### Core UI Components

#### GameCard (src/components/GameCard.tsx)

```typescript
interface GameCardProps {
  game: Game;
  pick?: Pick;
  onPickSubmit?: (gameId: string, teamId: string) => Promise<void>;
  showLockStatus?: boolean;
  className?: string;
}

export const GameCard: React.FC<GameCardProps> = ({
  game,
  pick,
  onPickSubmit,
  showLockStatus = true,
  className = ''
}) => {
  const [isSubmitting, setIsSubmitting] = useState(false)
  const isLocked = useMemo(() =>
    Date.now() >= new Date(game.lockTime).getTime(),
    [game.lockTime]
  )

  return (
    <div className={`game-card ${className}`}>
      <GameHeader game={game} />
      {showLockStatus && <GameLockStatus game={game} />}
      <TeamsDisplay
        homeTeam={game.homeTeam}
        awayTeam={game.awayTeam}
        spread={game.spread}
        overUnder={game.overUnder}
      />
      {!isLocked && onPickSubmit && (
        <PickSelector
          game={game}
          currentPick={pick}
          onSubmit={onPickSubmit}
          isSubmitting={isSubmitting}
        />
      )}
      {game.isCompleted && <GameResult game={game} pick={pick} />}
    </div>
  )
}
```

#### CountdownTimer (src/components/CountdownTimer.tsx)

```typescript
interface CountdownTimerProps {
  targetTime: string;
  onExpire?: () => void;
  className?: string;
}

export const CountdownTimer: React.FC<CountdownTimerProps> = ({
  targetTime,
  onExpire,
  className = ''
}) => {
  const [timeRemaining, setTimeRemaining] = useState(0)

  useEffect(() => {
    const updateTimer = () => {
      const remaining = Math.max(0,
        new Date(targetTime).getTime() - Date.now()
      )
      setTimeRemaining(remaining)

      if (remaining === 0 && onExpire) {
        onExpire()
      }
    }

    updateTimer()
    const interval = setInterval(updateTimer, 1000)

    return () => clearInterval(interval)
  }, [targetTime, onExpire])

  const formatted = formatDuration(Math.floor(timeRemaining / 1000))
  const isUrgent = timeRemaining < 3600000 // Less than 1 hour

  return (
    <div className={`countdown-timer ${isUrgent ? 'urgent' : ''} ${className}`}>
      <ClockIcon className="w-4 h-4" />
      <span>{formatted}</span>
    </div>
  )
}
```

#### GameLockStatus (src/components/GameLockStatus.tsx)

```typescript
interface GameLockStatusProps {
  game: GameStatus;
  showCountdown?: boolean;
  className?: string;
}

export const GameLockStatus: React.FC<GameLockStatusProps> = ({
  game,
  showCountdown = true,
  className = ''
}) => {
  if (game.isLocked) {
    return (
      <div className={`lock-status locked ${className}`}>
        <LockClosedIcon className="w-5 h-5" />
        <span>Picks Locked</span>
      </div>
    )
  }

  if (game.isLockingSoon && showCountdown) {
    return (
      <div className={`lock-status locking-soon ${className}`}>
        <ExclamationIcon className="w-5 h-5" />
        <span>Locking in:</span>
        <CountdownTimer targetTime={game.lockTime} />
      </div>
    )
  }

  return (
    <div className={`lock-status open ${className}`}>
      <LockOpenIcon className="w-5 h-5" />
      <span>Picks Open</span>
      {showCountdown && <CountdownTimer targetTime={game.lockTime} />}
    </div>
  )
}
```

### Mobile Components

#### MobileGameCard (src/components/mobile/MobileGameCard.tsx)

```typescript
// Optimized for small screens, touch interactions
export const MobileGameCard: React.FC<MobileGameCardProps> = ({
  game,
  pick,
  onPickSubmit
}) => {
  const [showDetails, setShowDetails] = useState(false)

  return (
    <div className="mobile-game-card" onClick={() => setShowDetails(true)}>
      <div className="teams-compact">
        <TeamLogo team={game.awayTeam} size="sm" />
        <span className="vs">@</span>
        <TeamLogo team={game.homeTeam} size="sm" />
      </div>
      <GameTime time={game.gameDate} />
      <LockIndicator isLocked={game.isLocked} timeUntilLock={game.timeUntilLock} />

      {showDetails && (
        <MobilePickModal
          game={game}
          pick={pick}
          onSubmit={onPickSubmit}
          onClose={() => setShowDetails(false)}
        />
      )}
    </div>
  )
}
```

#### MobileNavigation (src/components/mobile/MobileNavigation.tsx)

```typescript
// Bottom tab bar navigation
export const MobileNavigation: React.FC = () => {
  const location = useLocation()

  const tabs = [
    { path: '/', icon: HomeIcon, label: 'Home' },
    { path: '/games', icon: CalendarIcon, label: 'Games' },
    { path: '/leaderboard', icon: TrophyIcon, label: 'Leaderboard' },
    { path: '/profile', icon: UserIcon, label: 'Profile' }
  ]

  return (
    <nav className="mobile-nav">
      {tabs.map(tab => (
        <Link
          key={tab.path}
          to={tab.path}
          className={`nav-tab ${location.pathname === tab.path ? 'active' : ''}`}
        >
          <tab.icon className="w-6 h-6" />
          <span>{tab.label}</span>
        </Link>
      ))}
    </nav>
  )
}
```

### Custom Hooks

#### useRealTimeUpdates (src/hooks/useRealTimeUpdates.ts)

```typescript
// SSE/polling connection management with reconnection logic
export const useRealTimeUpdates = (userId: string, token: string) => {
  const [events, setEvents] = useState<RealTimeEvent[]>([])
  const [isConnected, setIsConnected] = useState(false)
  const eventSourceRef = useRef<EventSource | null>(null)
  const reconnectAttemptsRef = useRef(0)
  const maxReconnectAttempts = 5

  // SSE connection with auto-reconnect
  const connect = useCallback(() => {
    const eventSource = new EventSource(
      `${API_BASE_URL}/api/events/stream`,
      { headers: { 'Authorization': `Bearer ${token}` } }
    )

    eventSource.onopen = () => {
      setIsConnected(true)
      reconnectAttemptsRef.current = 0
    }

    eventSource.onerror = () => {
      setIsConnected(false)
      eventSource.close()

      if (reconnectAttemptsRef.current < maxReconnectAttempts) {
        const delay = Math.min(1000 * Math.pow(2, reconnectAttemptsRef.current), 30000)
        setTimeout(connect, delay)
        reconnectAttemptsRef.current++
      } else {
        // Fall back to polling
        startPolling()
      }
    }

    eventSource.onmessage = (event) => {
      const data = JSON.parse(event.data)
      setEvents(prev => [...prev, data])
    }

    eventSourceRef.current = eventSource
  }, [userId, token])

  useEffect(() => {
    connect()

    return () => {
      if (eventSourceRef.current) {
        eventSourceRef.current.close()
      }
    }
  }, [connect])

  return { events, isConnected }
}
```

#### useMobileViewport (src/hooks/useMobileViewport.ts)

```typescript
// Media query hooks for responsive design
export const useMobileViewport = () => {
  const [isMobile, setIsMobile] = useState(false)
  const [isTablet, setIsTablet] = useState(false)

  useEffect(() => {
    const mobileQuery = window.matchMedia('(max-width: 768px)')
    const tabletQuery = window.matchMedia('(min-width: 769px) and (max-width: 1024px)')

    const updateViewport = () => {
      setIsMobile(mobileQuery.matches)
      setIsTablet(tabletQuery.matches)
    }

    updateViewport()

    mobileQuery.addEventListener('change', updateViewport)
    tabletQuery.addEventListener('change', updateViewport)

    return () => {
      mobileQuery.removeEventListener('change', updateViewport)
      tabletQuery.removeEventListener('change', updateViewport)
    }
  }, [])

  return { isMobile, isTablet, isDesktop: !isMobile && !isTablet }
}
```

#### useGameStatus (src/hooks/useGameStatus.ts)

```typescript
// Game lock status calculation with real-time updates
export const useGameStatus = (game: Game) => {
  const [status, setStatus] = useState<GameStatus>(() => calculateStatus(game))

  useEffect(() => {
    const interval = setInterval(() => {
      setStatus(calculateStatus(game))
    }, 1000)

    return () => clearInterval(interval)
  }, [game])

  return status
}

function calculateStatus(game: Game): GameStatus {
  const lockTime = new Date(game.lockTime).getTime()
  const now = Date.now()
  const timeUntilLock = Math.max(0, lockTime - now)
  const isLocked = timeUntilLock === 0
  const isLockingSoon = timeUntilLock > 0 && timeUntilLock < 3600000 // 1 hour

  return {
    ...game,
    isLocked,
    timeUntilLock,
    isLockingSoon
  }
}
```

---

## 8. Build Configuration

### Vite Configuration (vite.config.ts)

```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { VitePWA } from 'vite-plugin-pwa'

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      includeAssets: ['favicon.ico', 'robots.txt', 'apple-touch-icon.png'],
      manifest: {
        name: 'NFL Pick\'em',
        short_name: 'Pick\'em',
        description: 'Family NFL Pick\'em Competition',
        theme_color: '#1a1a1a',
        icons: [
          {
            src: 'pwa-192x192.png',
            sizes: '192x192',
            type: 'image/png'
          },
          {
            src: 'pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png'
          }
        ]
      },
      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}'],
        runtimeCaching: [
          {
            urlPattern: /^https:\/\/nfl-pickem-app-production\.cybermattlee-llc\.workers\.dev\/api\/.*/i,
            handler: 'NetworkFirst',
            options: {
              cacheName: 'api-cache',
              expiration: {
                maxEntries: 100,
                maxAgeSeconds: 60 * 60 * 24 * 7 // 7 days
              },
              cacheableResponse: {
                statuses: [0, 200]
              }
            }
          },
          {
            urlPattern: /^https:\/\/.*\.(png|jpg|jpeg|svg|gif)$/i,
            handler: 'CacheFirst',
            options: {
              cacheName: 'images-cache',
              expiration: {
                maxEntries: 60,
                maxAgeSeconds: 60 * 60 * 24 * 30 // 30 days
              }
            }
          }
        ]
      }
    })
  ],
  build: {
    target: 'es2020',
    outDir: 'dist',
    sourcemap: true,
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom', 'react-router-dom'],
          ui: ['@heroicons/react']
        }
      }
    },
    chunkSizeWarningLimit: 300
  },
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:8787',
        changeOrigin: true
      }
    }
  }
})
```

### TypeScript Configuration (tsconfig.json)

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "forceConsistentCasingInFileNames": true,

    /* Path mapping */
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"],
      "@components/*": ["./src/components/*"],
      "@hooks/*": ["./src/hooks/*"],
      "@utils/*": ["./src/utils/*"],
      "@types/*": ["./src/types/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

### Tailwind Configuration (tailwind.config.ts)

```typescript
import type { Config } from 'tailwindcss'

export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  darkMode: 'class', // Manual toggle
  theme: {
    extend: {
      colors: {
        brand: {
          50: '#f0f9ff',
          100: '#e0f2fe',
          200: '#bae6fd',
          300: '#7dd3fc',
          400: '#38bdf8',
          500: '#0ea5e9',
          600: '#0284c7',
          700: '#0369a1',
          800: '#075985',
          900: '#0c4a6e',
        },
        success: {
          light: '#d1fae5',
          DEFAULT: '#10b981',
          dark: '#065f46',
        },
        warning: {
          light: '#fef3c7',
          DEFAULT: '#f59e0b',
          dark: '#92400e',
        },
        danger: {
          light: '#fee2e2',
          DEFAULT: '#ef4444',
          dark: '#991b1b',
        }
      },
      animation: {
        'accordion-down': 'accordion-down 0.2s ease-out',
        'accordion-up': 'accordion-up 0.2s ease-out',
      },
      keyframes: {
        'accordion-down': {
          from: { height: '0' },
          to: { height: 'var(--radix-accordion-content-height)' },
        },
        'accordion-up': {
          from: { height: 'var(--radix-accordion-content-height)' },
          to: { height: '0' },
        },
      },
    },
  },
  plugins: [
    require('tailwindcss-animate'),
  ],
} satisfies Config
```

### Wrangler Configuration (wrangler-workers.toml)

```toml
name = "nfl-pickem-app-production"
main = "src/worker.ts"
compatibility_date = "2024-01-01"
node_compat = true

[[d1_databases]]
binding = "DB"
database_name = "nfl-pickem-db"
database_id = "your-database-id-here"

[triggers]
crons = ["*/15 * * * *"]

[env.production]
name = "nfl-pickem-app-production"

[env.production.vars]
NODE_ENV = "production"
CURRENT_NFL_SEASON = "2025"
CURRENT_NFL_WEEK = "1"
THE_ODDS_API_BASE_URL = "https://api.the-odds-api.com/v4"

[[env.production.routes]]
pattern = "pickem.cyberlees.dev/*"
custom_domain = true

[env.development]
name = "nfl-pickem-app-dev"

[env.development.vars]
NODE_ENV = "development"
```

---

## 9. Deployment Architecture

### Frontend Deployment Flow

```
Developer Push → GitHub Main Branch
    ↓
Cloudflare Pages Auto-Detect
    ↓
Build: npm run build (Vite)
    ↓
Output: /dist directory
    ↓
Deploy to CDN: pickem.cyberlees.dev
    ↓
Service Worker Registers
    ↓
PWA Ready (offline support, install prompt)
```

### Backend Deployment Flow

```
Developer: wrangler deploy
    ↓
src/worker.ts TypeScript Compilation
    ↓
Bundle with Dependencies
    ↓
Upload to Cloudflare Workers
    ↓
API Live: nfl-pickem-app-production.cybermattlee-llc.workers.dev
    ↓
D1 Database Binding Active
    ↓
Cron Triggers Start (*/15 * * * *)
```

### Production URLs

- **Frontend**: https://pickem.cyberlees.dev
- **API**: https://nfl-pickem-app-production.cybermattlee-llc.workers.dev
- **Database**: Cloudflare D1 (internal, access via Wrangler or Workers)

### Deployment Commands

```bash
# Frontend deployment (automatic via git push)
git push origin main
# → Cloudflare Pages auto-builds and deploys

# Backend deployment
npm run workers:deploy          # Deploy to default environment
npm run workers:deploy-prod     # Deploy with --env production

# Full stack deployment
npm run prod:deploy             # Build + deploy + health check

# Verify deployment
curl https://pickem.cyberlees.dev/health
curl https://nfl-pickem-app-production.cybermattlee-llc.workers.dev/api/health
```

### Environment Management

```bash
# Set production secrets
wrangler secret put JWT_SECRET
wrangler secret put THE_ODDS_API_KEY

# List secrets
wrangler secret list

# Delete secret
wrangler secret delete SECRET_NAME

# View environment variables
wrangler whoami
wrangler pages project list
```

### Database Management

```bash
# Execute SQL on production database
wrangler d1 execute nfl-pickem-db --remote --command="SELECT COUNT(*) FROM games;"

# Backup database (export to SQL)
wrangler d1 backup create nfl-pickem-db

# List backups
wrangler d1 backup list nfl-pickem-db

# Restore from backup
wrangler d1 backup restore nfl-pickem-db --backup-id=<id>

# Run migrations
npm run prod:migrate
```

---

## 10. Security Features

### Authentication System

#### Password Hashing

```typescript
// src/worker.ts:887-903
import bcrypt from 'bcryptjs'

async function hashPassword(password: string): Promise<string> {
  const salt = await bcrypt.genSalt(12) // 12 rounds
  return bcrypt.hash(password, salt)
}

async function verifyPassword(password: string, hash: string): Promise<boolean> {
  return bcrypt.compare(password, hash)
}

// User registration
const passwordHash = await hashPassword(requestData.password)
await db.prepare(`
  INSERT INTO users (id, email, passwordHash, name, role, createdAt, updatedAt)
  VALUES (?, ?, ?, ?, ?, ?, ?)
`).bind(
  crypto.randomUUID(),
  email,
  passwordHash,
  name,
  'user',
  now,
  now
).run()
```

#### JWT Tokens

```typescript
// src/worker.ts:869-885
import { SignJWT, jwtVerify } from 'jose'

async function createJWT(payload: any, env: Env): Promise<string> {
  const secret = new TextEncoder().encode(env.JWT_SECRET || 'dev-secret')
  return new SignJWT(payload)
    .setProtectedHeader({ alg: 'HS256' })
    .setIssuedAt()
    .setExpirationTime('24h')
    .sign(secret)
}

async function verifyJWT(token: string, env: Env): Promise<any> {
  const secret = new TextEncoder().encode(env.JWT_SECRET || 'dev-secret')
  try {
    const { payload } = await jwtVerify(token, secret)
    return payload
  } catch (error) {
    throw new Error('Invalid token')
  }
}
```

#### Protected Route Pattern

```typescript
// Middleware for authentication
async function requireAuth(request: Request, env: Env): Promise<string> {
  const authHeader = request.headers.get('Authorization')
  if (!authHeader?.startsWith('Bearer ')) {
    throw new Error('Missing authorization token')
  }

  const token = authHeader.substring(7)
  const payload = await verifyJWT(token, env)

  if (!payload.userId) {
    throw new Error('Invalid token payload')
  }

  return payload.userId
}

// Usage in endpoint
const userId = await requireAuth(request, env)
```

### Authorization

#### Role-Based Access Control

```typescript
// User roles defined in database
enum UserRole {
  USER = 'user',
  ADMIN = 'admin'
}

// Check admin role
async function requireAdmin(request: Request, env: Env): Promise<void> {
  const userId = await requireAuth(request, env)

  const { results } = await env.DB.prepare(
    'SELECT role FROM users WHERE id = ?'
  ).bind(userId).all()

  if (results[0]?.role !== 'admin') {
    throw new Error('Unauthorized: Admin access required')
  }
}

// Admin-only endpoint
if (endpoint === '/api/system/migrate') {
  await requireAdmin(request, env)
  // ... proceed with migration
}
```

#### API Key Validation

```typescript
// src/worker.ts:441-470
const validApiKeys = ['ESPN-SYSTEM-SYNC-2025']

function validateApiKey(request: Request, env: Env): boolean {
  const apiKey = request.headers.get('X-API-Key')

  // Check against static keys
  if (validApiKeys.includes(apiKey)) {
    return true
  }

  // Check against env secret
  if (apiKey === env.THE_ODDS_API_KEY) {
    return true
  }

  return false
}

// Protected endpoint
if (endpoint === '/api/odds/sync') {
  if (!validateApiKey(request, env)) {
    return new Response('Unauthorized', { status: 401 })
  }
  // ... proceed with sync
}
```

### CORS Configuration

```typescript
// src/worker.ts:46-54
const corsHeaders = {
  'Access-Control-Allow-Origin': 'https://pickem.cyberlees.dev',
  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-API-Key',
  'Access-Control-Max-Age': '86400',
  'Content-Type': 'application/json'
}

// Handle OPTIONS preflight
if (request.method === 'OPTIONS') {
  return new Response(null, {
    status: 204,
    headers: corsHeaders
  })
}

// Apply CORS to all responses
return new Response(JSON.stringify(data), {
  status: 200,
  headers: corsHeaders
})
```

### Data Protection

#### SQL Injection Prevention

```typescript
// ALWAYS use prepared statements with bind parameters
const { results } = await env.DB.prepare(`
  SELECT * FROM games
  WHERE week = ? AND season = ?
`).bind(week, season).all()

// NEVER concatenate user input into SQL
// ❌ BAD: `SELECT * FROM users WHERE email = '${email}'`
// ✅ GOOD: prepare('SELECT * FROM users WHERE email = ?').bind(email)
```

#### Input Validation with Zod

```typescript
// lib/db-workers.ts
import { z } from 'zod'

const PickSubmissionSchema = z.object({
  userId: z.string().uuid(),
  gameId: z.string().uuid(),
  teamId: z.string().uuid()
})

// Validate before processing
try {
  const validatedData = PickSubmissionSchema.parse(requestBody)
  // ... proceed with validated data
} catch (error) {
  return new Response('Invalid input', { status: 400 })
}
```

#### Secure Headers

```typescript
// Security headers applied to all responses
const securityHeaders = {
  'X-Content-Type-Options': 'nosniff',
  'X-Frame-Options': 'DENY',
  'X-XSS-Protection': '1; mode=block',
  'Referrer-Policy': 'strict-origin-when-cross-origin',
  'Permissions-Policy': 'geolocation=(), microphone=(), camera=()'
}

function createSecureResponse(data: any): Response {
  return new Response(JSON.stringify(data), {
    headers: {
      ...corsHeaders,
      ...securityHeaders
    }
  })
}
```

### Rate Limiting (Planned)

```typescript
// Future implementation pattern
interface RateLimitConfig {
  windowMs: number;
  maxRequests: number;
}

const rateLimits: Record<string, RateLimitConfig> = {
  '/api/auth/signin': { windowMs: 60000, maxRequests: 5 },
  '/api/picks': { windowMs: 60000, maxRequests: 30 },
  default: { windowMs: 60000, maxRequests: 100 }
}

async function checkRateLimit(
  request: Request,
  env: Env
): Promise<boolean> {
  const ip = request.headers.get('CF-Connecting-IP')
  const endpoint = new URL(request.url).pathname
  const config = rateLimits[endpoint] || rateLimits.default

  // Use Cloudflare KV to track request counts
  const key = `ratelimit:${ip}:${endpoint}`
  const count = await env.RATE_LIMIT_KV.get(key)

  if (count && parseInt(count) >= config.maxRequests) {
    return false
  }

  await env.RATE_LIMIT_KV.put(
    key,
    (parseInt(count || '0') + 1).toString(),
    { expirationTtl: config.windowMs / 1000 }
  )

  return true
}
```

### HTTPS Enforcement

```typescript
// Cloudflare automatically redirects HTTP → HTTPS in production
// Additional check in worker
if (env.NODE_ENV === 'production' &&
    new URL(request.url).protocol !== 'https:') {
  return Response.redirect(
    request.url.replace('http:', 'https:'),
    301
  )
}
```

### Test Credentials

**Available for Development/Testing:**

- **Email**: test@example.com
- **Password**: password123
- **Role**: user

**Note**: Test user is seeded in production database for QA purposes.

---

## Summary

This architecture document provides a comprehensive overview of the NFL Pick'em app's:

- **Modern Stack**: React + Vite frontend, Cloudflare Workers backend, D1 SQLite database
- **Production-Ready**: Live at https://pickem.cyberlees.dev with automated deployments
- **Real-Time Features**: Time-lock system, live score updates, SSE/polling for events
- **Security**: JWT auth, bcrypt hashing, prepared statements, CORS restrictions
- **Scalability**: Cloudflare edge network, automatic scaling, PWA offline support
- **Developer Experience**: TypeScript throughout, hot reload, comprehensive testing

The codebase is well-organized, fully typed, and ready for ongoing development and feature additions.

---

**Document Version**: 1.0
**Last Updated**: November 20, 2025
**Maintained By**: NFL Pick'em Development Team
