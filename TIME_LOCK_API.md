# Time-Lock Pick System API Documentation

## Overview

The Time-Lock Pick System enforces time-based restrictions on NFL game picks, ensuring users cannot modify picks after games are locked (typically 15 minutes before kickoff). This documentation covers Sprint 2 implementation with enhanced APIs for pick validation, game status tracking, and automated pick generation.

## Core Concepts

- **Lock Time**: Games lock 15 minutes before kickoff time
- **Game Status**: `upcoming` → `locked` → `in_progress` → `final`
- **Pick Locking**: Once submitted, picks are immediately locked
- **Auto-Generation**: System creates random picks for users who miss deadlines

## API Endpoints

### 1. Enhanced Picks API (`/api/picks`)

#### POST `/api/picks` - Submit Pick with Time-Lock Validation

**Request Body:**
```typescript
{
  userId: string;    // User UUID
  gameId: string;    // Game UUID  
  teamId: string;    // Team UUID (must be playing in this game)
}
```

**Response (Success - 201):**
```typescript
{
  success: true;
  pick: {
    id: string;              // Format: "{userId}-{gameId}"
    userId: string;
    gameId: string;
    teamId: string;
    isLocked: true;          // Always true when submitted
    lockedAt: string;        // ISO timestamp
    autoGenerated: false;    // Always false for user picks
    timeUntilLock: number;   // Milliseconds until game locks
  }
}
```

**Error Responses:**
- **400**: Missing required fields or invalid team
- **403**: Game is locked or pick already locked
- **404**: Game not found
- **500**: Server error

#### GET `/api/picks` - Retrieve All Picks with Lock Status

**Response:**
```typescript
{
  picks: Array<{
    gameId: string;
    userId: string;
    teamId: string;
    userName: string;
    teamAbbr: string;
    isLocked: boolean;
    lockedAt?: string;
    autoGenerated: boolean;
    timeUntilLock: number;
  }>
}
```

### 2. Game Status API (`/api/games/status`)

#### GET `/api/games/status` - Get Games with Lock Status

**Query Parameters:**
- `status` (optional): Filter by `upcoming`, `locked`, `in_progress`, `final`
- `week` (optional): Filter by NFL week number
- `season` (optional): Filter by season year

**Response:**
```typescript
{
  games: Array<{
    id: string;
    week: number;
    season: number;
    homeTeamId: string;
    awayTeamId: string;
    gameDate: string;        // ISO timestamp
    lockTime: string;        // ISO timestamp
    status: 'upcoming' | 'locked' | 'in_progress' | 'final';
    timeUntilLock: number;   // Milliseconds until lock (0 if locked)
    isLocked: boolean;       // Current lock status
    homeTeamAbbr: string;    // Team abbreviation (e.g., "KC")
    awayTeamAbbr: string;
  }>;
  count: number;
  timestamp: string;
}
```

**Example Usage:**
```bash
GET /api/games/status?status=upcoming&week=1
GET /api/games/status?season=2025
```

### 3. Auto-Generate Picks API (`/api/picks/auto-generate`)

#### POST `/api/picks/auto-generate` - Generate Random Picks for Missing Users

Finds locked games where users haven't made picks and creates random selections.

**Response:**
```typescript
{
  success: true;
  autoGeneratedCount: number;    // Total picks generated
  gamesProcessed: number;        // Number of locked games checked
  details: Array<{
    gameId: string;
    usersGenerated: number;      // Picks generated for this game
  }>;
}
```

**Use Cases:**
- Called by Cron triggers after games lock
- Manual trigger for testing or emergency situations
- Ensures all users have picks for scoring calculations

### 4. Update Game Locks API (`/api/games/update-locks`)

#### POST `/api/games/update-locks` - Update Game Lock Statuses

Checks all games and updates status from `upcoming` to `locked` when current time passes lockTime.

**Response:**
```typescript
{
  success: true;
  newlyLockedGames: number;      // Count of games just locked
  gameIds: string[];             // Array of newly locked game IDs
  timestamp: string;
}
```

**Database Operations:**
- Updates `games.status` to `'locked'`
- Updates `game_locks` table entries
- Prepares games for auto-pick generation

### 5. Utility APIs

#### POST `/api/games/populate-lock-times` - Populate Missing Lock Times

One-time utility to set lockTime for existing games without this field.

**Response:**
```typescript
{
  success: true;
  message: string;
  updatedCount: number;
  timestamp: string;
}
```

## Validation Functions

### Core Validation Logic

```typescript
// Check if game accepts new picks
async function isGameLocked(gameId: string): Promise<boolean>

// Check if user can modify existing pick  
async function canUserChangePick(userId: string, gameId: string): Promise<boolean>

// Calculate milliseconds until game locks
async function getTimeUntilLock(lockTime: string): Promise<number>
```

### Business Rules

1. **Pick Submission**: 
   - Must be before game lockTime
   - Team must be playing in the game
   - Once submitted, pick is immediately locked

2. **Game Locking**:
   - Games lock 15 minutes before kickoff
   - Status transitions: `upcoming` → `locked` → `in_progress` → `final`
   - Lock updates are idempotent

3. **Auto-Generation**:
   - Only for locked games
   - Only for users without existing picks
   - Random selection between home/away teams
   - Marked with `autoGenerated: true`

## Database Schema Integration

### Updated Tables

**games table additions:**
```sql
lockTime TEXT NOT NULL,           -- When picks lock
status TEXT DEFAULT 'upcoming',  -- Game status
```

**picks table additions:**
```sql
lockedAt TEXT,                    -- When pick was submitted
isLocked BOOLEAN DEFAULT 0,      -- Pick change protection
autoGenerated BOOLEAN DEFAULT 0,  -- System-generated flag
```

**game_locks table:**
```sql
CREATE TABLE game_locks (
  id TEXT PRIMARY KEY,
  gameId TEXT NOT NULL UNIQUE,
  lockTime TEXT NOT NULL,
  isLocked BOOLEAN DEFAULT 0,
  lastChecked TEXT NOT NULL,
  autoPicksGenerated BOOLEAN DEFAULT 0,
  -- timestamps...
);
```

### Optimized Indexes

```sql
-- Time-lock performance indexes
CREATE INDEX idx_games_lock_time ON games(lockTime);
CREATE INDEX idx_games_status ON games(status);
CREATE INDEX idx_games_status_lock_time ON games(status, lockTime);
CREATE INDEX idx_picks_is_locked ON picks(isLocked);
CREATE INDEX idx_picks_auto_generated ON picks(autoGenerated);
```

## Error Handling

### HTTP Status Codes

- **200**: Success (GET requests)
- **201**: Created (successful pick submission)
- **400**: Bad request (validation errors)
- **403**: Forbidden (time-lock violations)
- **404**: Not found (invalid game/user)
- **500**: Internal server error

### Error Response Format

```typescript
{
  error: string;           // Error type
  message?: string;        // Human-readable description
  details?: string;        // Technical details
  gameId?: string;         // Context for game-related errors
  required?: string[];     // Missing fields for validation errors
}
```

## Integration with Cloudflare Workers

### Cron Trigger Integration

```typescript
// wrangler.toml
[triggers]
crons = ["*/15 * * * *"]  // Every 15 minutes

// In scheduled handler:
async function scheduled(event, env, ctx) {
  // 1. Update game locks
  await fetch(`${env.WORKER_URL}/api/games/update-locks`, { method: 'POST' });
  
  // 2. Generate missing picks
  await fetch(`${env.WORKER_URL}/api/picks/auto-generate`, { method: 'POST' });
}
```

### Production Deployment

```bash
# Deploy worker with time-lock system
wrangler publish

# Populate lockTimes for existing games (one-time)
curl -X POST https://your-worker.workers.dev/api/games/populate-lock-times

# Test lock updates
curl -X POST https://your-worker.workers.dev/api/games/update-locks
```

## Testing Scenarios

### 1. Normal Pick Flow
```bash
# Check game status (should be upcoming)
GET /api/games/status?week=1

# Submit pick (should succeed)
POST /api/picks
{
  "userId": "test-user-id",
  "gameId": "game-id",
  "teamId": "team-kc"
}

# Try to modify pick (should fail - already locked)
POST /api/picks  # Same data - should return 403
```

### 2. Time-Lock Enforcement
```bash
# Update locks manually (advance time)
POST /api/games/update-locks

# Try to pick locked game (should fail)
POST /api/picks  # Should return 403 "Game is locked"
```

### 3. Auto-Pick Generation
```bash
# Generate picks for users without picks
POST /api/picks/auto-generate

# Verify picks were created
GET /api/picks  # Should include autoGenerated: true picks
```

## Performance Considerations

### Database Query Optimization

- Uses indexed columns for time comparisons
- Batched operations for bulk updates
- Prepared statements for repeated queries

### Caching Strategy

- Game lock status cached for 5-minute intervals
- Pick validation cached per user/game combination
- Time calculations performed client-side when possible

### Rate Limiting Recommendations

- Pick submissions: 10 requests/minute per user
- Status queries: 100 requests/minute per IP
- Bulk operations: Admin-only access

## Security Considerations

### Input Validation

- All UUIDs validated for format
- Team membership verified against game data
- User permissions checked for all operations

### Time-Based Attack Prevention

- Server-side time validation only
- No client-side time manipulation accepted
- Lock times stored in UTC for consistency

### Access Control

- User can only submit picks for themselves
- Game status is public information
- Bulk operations require authentication

## Future Enhancements (Sprint 3+)

### Confidence Points System
- Allow users to assign confidence points to picks
- Higher risk/reward for confident selections

### Advanced Auto-Pick Strategies  
- Favor home teams or underdogs
- Use historical performance data
- User-configurable auto-pick preferences

### Real-Time Updates
- WebSocket connections for live lock countdowns
- Push notifications before games lock
- Live score updates during games

## Support and Monitoring

### Logging

All time-lock operations are logged with:
- Timestamp and user context
- Game and pick details
- Error messages and stack traces
- Performance metrics

### Health Checks

```bash
# Verify system functionality
GET /api/games/status?status=upcoming  # Should return upcoming games
POST /api/games/update-locks           # Should return success
GET /api/picks                         # Should return all picks
```

### Monitoring Alerts

- Games not locking on schedule
- Auto-pick generation failures  
- Unusual pick submission patterns
- Database performance degradation

---

**Sprint 2 Status**: ✅ Complete - Ready for production deployment
**Next Sprint**: Real-time UI integration and advanced pick strategies