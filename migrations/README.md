# Database Migrations - Time-Lock System Sprint 1

This directory contains database migration scripts for implementing the time-lock pick system in the NFL Pick'em app.

## Migration 001: Add Time-Lock Fields

### Purpose
Adds time-lock functionality to support:
- Picks that lock at game time
- Automatic random picks for users who don't submit
- Real-time status tracking of games
- Historical tracking of when picks were made

### Changes Made

#### Games Table Enhancements
- `lockTime` TEXT NOT NULL - When picks lock (typically kickoff time)
- `status` TEXT - Game status: 'upcoming', 'locked', 'in_progress', 'final'

#### Picks Table Enhancements  
- `lockedAt` TEXT - Timestamp when pick was submitted/locked
- `isLocked` BOOLEAN - Whether the pick can be changed
- `autoGenerated` BOOLEAN - If system made the pick automatically

#### New Game Locks Table
- Tracks lock status for each game
- Supports background processing for auto-pick generation
- Optimized for time-based queries

#### Performance Indexes
- 11 new indexes optimized for time-lock operations
- Composite indexes for common query patterns
- Ensures sub-100ms query performance

## Wrangler Commands

### Apply Migration (Production)
```bash
# Apply the migration to production D1 database
wrangler d1 execute nfl-pickem-db --file=migrations/001_add_time_lock_fields.sql

# Verify migration was successful
wrangler d1 execute nfl-pickem-db --command="SELECT COUNT(*) as total_games FROM games;"
wrangler d1 execute nfl-pickem-db --command="SELECT COUNT(*) as total_game_locks FROM game_locks;"
wrangler d1 execute nfl-pickem-db --command="SELECT status, COUNT(*) as count FROM games GROUP BY status;"
```

### Apply Migration (Local Development)
```bash
# Apply the migration to local D1 database
wrangler d1 execute nfl-pickem-db --local --file=migrations/001_add_time_lock_fields.sql

# Verify migration was successful locally
wrangler d1 execute nfl-pickem-db --local --command="SELECT COUNT(*) as total_games FROM games;"
wrangler d1 execute nfl-pickem-db --local --command="SELECT COUNT(*) as total_game_locks FROM game_locks;"
```

### Rollback Migration (DANGER - Data Loss)
```bash
# Rollback migration (removes all time-lock data)
wrangler d1 execute nfl-pickem-db --file=migrations/001_rollback_time_lock_fields.sql

# For local development
wrangler d1 execute nfl-pickem-db --local --file=migrations/001_rollback_time_lock_fields.sql
```

### Inspection Commands
```bash
# Check table structure after migration
wrangler d1 execute nfl-pickem-db --command="PRAGMA table_info(games);"
wrangler d1 execute nfl-pickem-db --command="PRAGMA table_info(picks);"
wrangler d1 execute nfl-pickem-db --command="PRAGMA table_info(game_locks);"

# Check indexes were created
wrangler d1 execute nfl-pickem-db --command="SELECT name FROM sqlite_master WHERE type='index' AND name LIKE 'idx_%';"

# Check game status distribution
wrangler d1 execute nfl-pickem-db --command="SELECT status, COUNT(*) as count FROM games GROUP BY status;"

# Check lock status of picks
wrangler d1 execute nfl-pickem-db --command="SELECT isLocked, COUNT(*) as count FROM picks GROUP BY isLocked;"
```

## Migration Logic

### Time Zone Handling
- All times stored as ISO 8601 strings in UTC
- Application layer handles timezone conversion for display
- lockTime initially set to gameDate (can be updated with precise kickoff times)

### Status Management
- `upcoming`: Game hasn't started, picks can be modified
- `locked`: Game time reached, picks are locked
- `in_progress`: Game is active
- `final`: Game completed with final score

### Automatic Lock Detection
- Migration sets initial status based on current time vs lockTime
- Existing picks are marked as locked if their game time has passed
- game_locks table tracks when locks were checked

### Data Integrity
- Foreign key constraints maintained
- Unique constraints preserved
- Default values ensure compatibility

## Testing the Migration

### Pre-Migration Validation
```bash
# Count existing data
wrangler d1 execute nfl-pickem-db --command="SELECT COUNT(*) as games FROM games;"
wrangler d1 execute nfl-pickem-db --command="SELECT COUNT(*) as picks FROM picks;"

# Check current schema
wrangler d1 execute nfl-pickem-db --command="PRAGMA table_info(games);"
```

### Post-Migration Validation  
```bash
# Verify all data preserved
wrangler d1 execute nfl-pickem-db --command="SELECT COUNT(*) as games FROM games;"
wrangler d1 execute nfl-pickem-db --command="SELECT COUNT(*) as picks FROM picks;"
wrangler d1 execute nfl-pickem-db --command="SELECT COUNT(*) as game_locks FROM game_locks;"

# Check new fields populated
wrangler d1 execute nfl-pickem-db --command="SELECT COUNT(*) as games_with_lock_time FROM games WHERE lockTime IS NOT NULL;"
```

### Sample Queries After Migration
```sql
-- Find games that need to be locked
SELECT id, lockTime, status FROM games 
WHERE status = 'upcoming' AND datetime(lockTime) <= datetime('now');

-- Find users without picks for upcoming games
SELECT DISTINCT u.id, u.email 
FROM users u 
CROSS JOIN games g 
LEFT JOIN picks p ON u.id = p.userId AND g.id = p.gameId 
WHERE g.status = 'upcoming' AND p.id IS NULL;

-- Check auto-generated picks
SELECT COUNT(*) as auto_picks FROM picks WHERE autoGenerated = 1;
```

## Next Steps

After applying this migration:

1. **Update API Endpoints** - Modify endpoints to handle new fields
2. **Implement Lock Logic** - Add pick validation based on game status
3. **Create Background Jobs** - Set up Cloudflare Cron triggers for auto-locks
4. **Update Frontend** - Show lock status and countdown timers
5. **Add Auto-Pick Logic** - Generate random picks for missed games

## Troubleshooting

### Common Issues
- **"no such column"**: Old code referencing removed fields - update queries
- **"UNIQUE constraint failed"**: Duplicate game_locks entries - check migration logic
- **"CHECK constraint failed"**: Invalid status values - ensure valid enum values

### Recovery
- Use rollback script if migration fails partially
- Restore from backup if data corruption occurs
- Re-run migration after fixing any data issues

## Performance Notes

- Migration adds ~11 new indexes (expect slight write performance impact)
- Query performance for time-based operations significantly improved
- game_locks table enables efficient background processing
- Composite indexes support complex filtering without table scans